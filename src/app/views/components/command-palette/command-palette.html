<p-dialog id="command-palette-dialog" [(visible)]="visible" [modal]="true" [showHeader]="false"
    [style]="{ width: '500px', maxHeight: '400px' }" [draggable]="false" [resizable]="false" [dismissableMask]="true"
    (onHide)="close()">

    <div id="command-palette-container" class="bg-surface-900 rounded-xl overflow-hidden">
        <!-- Search Input -->
        <div id="command-palette-input-wrapper" class="p-4 border-b border-surface-700">
            <div class="flex items-center gap-3">
                <i class="pi pi-search text-surface-0"></i>
                <input #searchInput pInputText type="text" [ngModel]="query()" (ngModelChange)="query.set($event)"
                    (keydown)="onKeydown($event)" placeholder="Search profiles..."
                    class="flex-1 bg-transparent border-none outline-none text-surface-0 text-sm placeholder:text-surface-0" />
                <kbd class="px-2 py-1 bg-surface-800 border border-surface-700 rounded text-xs text-surface-0">ESC</kbd>
            </div>
        </div>

        <!-- Results -->
        <div id="command-palette-results" class="max-h-[300px] overflow-auto">
            @if (filteredProfiles().length === 0) {
            <div class="p-8 text-center text-surface-0">
                <i class="pi pi-inbox text-2xl mb-2"></i>
                <p class="text-sm">No profiles found</p>
            </div>
            } @else {
            @for (profile of filteredProfiles(); track profile.path; let i = $index) {
            <button [id]="'command-palette-item-' + i" (click)="selectProfile(i)"
                class="w-full flex items-center gap-3 px-4 py-3 text-left transition-colors" [class]="selectedIndex() === i 
                            ? 'bg-primary/20 text-surface-0' 
                            : 'hover:bg-surface-800 text-surface-400'">

                <!-- Icon -->
                <span
                    class="w-8 h-8 rounded-lg bg-surface-800 border border-surface-700 flex items-center justify-center text-sm">
                    {{ getProfileDisplay(profile) }}
                </span>

                <!-- Info -->
                <div class="flex-1 min-w-0">
                    <div class="font-medium text-surface-0 truncate">{{ profile.name }}</div>
                    @if (profile.metadata?.group) {
                    <span class="text-xs text-surface-0">{{ profile.metadata?.group }}</span>
                    }
                </div>

                <!-- Tags -->
                @if (profile.metadata?.tags?.length) {
                <div class="flex gap-1">
                    @for (tag of profile.metadata!.tags!.slice(0, 2); track tag) {
                    <span class="px-2 py-0.5 bg-primary/20 border border-primary/40 rounded text-xs text-primary">
                        {{ tag }}
                    </span>
                    }
                </div>
                }

                <!-- Enter hint -->
                @if (selectedIndex() === i) {
                <kbd class="px-2 py-1 bg-surface-800 border border-surface-700 rounded text-xs text-surface-0">↵</kbd>
                }
            </button>
            }
            }
        </div>

        <!-- Footer -->
        <div id="command-palette-footer"
            class="px-4 py-2 border-t border-surface-700 flex items-center gap-4 text-xs text-surface-600">
            <span><kbd class="px-1 bg-surface-800 rounded">↑↓</kbd> Navigate</span>
            <span><kbd class="px-1 bg-surface-800 rounded">↵</kbd> Launch</span>
            <span><kbd class="px-1 bg-surface-800 rounded">ESC</kbd> Close</span>
        </div>
    </div>

</p-dialog>