<p-dialog id="home-edit-dialog" header="Edit Profile" [visible]="visible()" (visibleChange)="onVisibleChange($event)"
    [modal]="true" [style]="{ width: 'min(500px, 95vw)' }" [draggable]="false" [resizable]="false">
    <div id="home-edit-dialog-content" class="py-2 space-y-5">
        <!-- Icon -->
        <div id="home-edit-dialog-icon-section">
            <label class="block text-xs font-medium text-color mb-2">Icon</label>
            <div id="home-edit-dialog-icon-options" class="flex flex-wrap gap-2">
                @for (emoji of emojiOptions; track emoji; let i = $index) {
                <button [id]="'home-edit-dialog-emoji-' + i"
                    class="w-10 h-10 rounded-lg border flex items-center justify-center text-xl cursor-pointer transition-all duration-150"
                    [class]="editEmoji() === emoji ? 'bg-primary border-primary text-white' : 'border-surface hover:border-primary'"
                    (click)="selectEmoji(emoji)">
                    {{ emoji }}
                </button>
                }
            </div>
        </div>

        <!-- Group -->
        <div id="home-edit-dialog-group-section">
            <label class="block text-xs font-medium text-color mb-2">Group</label>
            <div id="home-edit-dialog-group-options" class="flex flex-wrap gap-2">
                @for (group of groupOptions; track group; let i = $index) {
                <button [id]="'home-edit-dialog-group-' + i"
                    class="px-3 py-2 rounded-lg border text-sm cursor-pointer transition-all duration-150"
                    [class]="editGroup() === group ? 'bg-primary border-primary text-white' : 'border-surface text-muted-color hover:border-primary'"
                    (click)="selectGroup(group)">
                    {{ group }}
                </button>
                }
            </div>
        </div>

        <!-- Shortcut -->
        <div id="home-edit-dialog-shortcut-section">
            <label class="block text-xs font-medium text-color mb-2">Keyboard Shortcut</label>
            <div id="home-edit-dialog-shortcut-options" class="flex flex-wrap gap-2">
                @for (num of shortcutOptions; track num; let i = $index) {
                <button [id]="'home-edit-dialog-shortcut-' + i"
                    class="w-10 h-10 rounded-lg border flex items-center justify-center text-sm font-mono cursor-pointer transition-all duration-150"
                    [class]="editShortcut() === num ? 'bg-primary border-primary text-white' : 'border-surface text-muted-color hover:border-primary'"
                    (click)="selectShortcut(num)">
                    ⌘{{ num }}
                </button>
                }
            </div>
        </div>

        <!-- Browser -->
        <div id="home-edit-dialog-browser-section">
            <label class="block text-xs font-medium text-color mb-2">Default Browser</label>
            <div id="home-edit-dialog-browser-options" class="flex flex-wrap gap-2">
                @for (browser of availableBrowsers(); track browser; let i = $index) {
                <button [id]="'home-edit-dialog-browser-' + i"
                    class="px-3 py-2 rounded-lg border text-sm cursor-pointer transition-all duration-150 flex items-center gap-2"
                    [class]="editBrowser() === browser ? 'bg-primary border-primary text-white' : 'border-surface text-muted-color hover:border-primary'"
                    (click)="selectBrowser($any(browser))">
                    <i [class]="'pi ' + browserInfo[browser].icon"></i>
                    {{ browserInfo[browser].name }}
                </button>
                }
            </div>
        </div>

        <!-- Color Coding -->
        <div id="home-edit-dialog-color-section">
            <label class="block text-xs font-medium text-color mb-2">Color</label>
            <div id="home-edit-dialog-color-options" class="flex flex-wrap gap-2">
                <!-- Clear color option -->
                <button id="home-edit-dialog-color-none"
                    class="w-8 h-8 rounded-full border-2 flex items-center justify-center cursor-pointer transition-all duration-150"
                    [class]="editColor() === null ? 'border-primary ring-2 ring-primary/30' : 'border-surface hover:border-primary'"
                    (click)="selectColor(null)" title="No color">
                    <i class="pi pi-times text-xs text-muted-color"></i>
                </button>
                @for (color of colorOptions; track color.name; let i = $index) {
                <button [id]="'home-edit-dialog-color-' + i"
                    class="w-8 h-8 rounded-full border-2 cursor-pointer transition-all duration-150"
                    [style.background-color]="color.hex"
                    [class]="editColor() === color.hex ? 'border-primary ring-2 ring-primary/30' : 'border-transparent hover:ring-2 hover:ring-surface'"
                    (click)="selectColor(color.hex)" [title]="color.label">
                </button>
                }
            </div>
        </div>

        <!-- Tags -->
        <div id="home-edit-dialog-tags-section">
            <label class="block text-xs font-medium text-color mb-2">Tags</label>
            <div class="flex flex-wrap gap-2">
                <input id="home-edit-dialog-tags-input" pInputText type="text"
                    placeholder="Type and press Enter to add tags" class="flex-1 min-w-[200px]"
                    (keydown.enter)="addTag($event)" />
            </div>
            @if (editTags().length > 0) {
            <div class="flex flex-wrap gap-2 mt-2">
                @for (tag of editTags(); track tag; let i = $index) {
                <span
                    class="inline-flex items-center gap-1.5 px-2.5 py-1 bg-primary/20 border border-primary/40 rounded-lg text-xs text-primary">
                    {{ tag }}
                    <button (click)="removeTag(i)" class="hover:text-muted-color transition-colors">
                        <i class="pi pi-times text-[10px]"></i>
                    </button>
                </span>
                }
            </div>
            }
        </div>

        <!-- Launch URL -->
        <div id="home-edit-dialog-url-section">
            <label for="home-edit-dialog-url-input" class="block text-xs font-medium text-color mb-2">Launch URL</label>
            <input id="home-edit-dialog-url-input" pInputText type="url" [ngModel]="editLaunchUrl()"
                (ngModelChange)="editLaunchUrl.set($event)" placeholder="https://example.com" class="w-full" />
            <p class="text-xs text-muted-color mt-1">Browser will open this URL when starting the profile</p>
        </div>

        <!-- Pin to Top -->
        <div id="home-edit-dialog-pin-section" class="flex items-center justify-between">
            <div>
                <label class="block text-xs font-medium text-color">Pin to Top</label>
                <p class="text-xs text-muted-color">Keep this profile at the top of the list</p>
            </div>
            <button (click)="editIsPinned.set(!editIsPinned())" class="w-12 h-7 rounded-full transition-colors relative"
                [class]="editIsPinned() ? 'bg-primary' : 'bg-surface-200 border border-surface'">
                <span class="absolute top-1 w-5 h-5 rounded-full shadow transition-all"
                    [class]="editIsPinned() ? 'left-6' : 'left-1'"></span>
            </button>
        </div>

        <!-- Proxy Setting (Upgraded) -->
        <div id="home-edit-dialog-proxy-section"
            class="space-y-3 p-3 rounded-lg border border-surface-200 dark:border-surface-700">
            <div class="flex items-center justify-between">
                <div>
                    <label class="block text-xs font-medium text-color">Proxy</label>
                    <p class="text-xs text-muted-color">Assign a proxy to this profile</p>
                </div>
            </div>

            <!-- Mode Selector -->
            <div class="flex gap-1">
                @for (opt of proxyModeOptions; track opt.value) {
                <button [id]="'home-edit-dialog-proxy-mode-' + opt.value"
                    class="flex-1 flex items-center justify-center gap-1.5 px-3 py-2 text-xs font-medium rounded-lg border transition-all"
                    [class]="proxyMode() === opt.value
                        ? 'bg-primary border-primary text-white'
                        : 'border-surface text-muted-color hover:border-primary'"
                    (click)="onProxyModeChange($any(opt.value))">
                    <i [class]="opt.icon + ' text-xs'"></i>
                    {{ opt.label }}
                </button>
                }
            </div>

            <!-- Saved Proxy Dropdown -->
            @if (proxyMode() === 'saved') {
            <div class="space-y-3">
                <p-select id="home-edit-dialog-proxy-select" [options]="savedProxies()" optionLabel="name"
                    optionValue="id" [ngModel]="selectedProxyId()"
                    (ngModelChange)="selectedProxyId.set($event); proxyCheckResult.set(null)"
                    placeholder="Select a proxy..." [showClear]="true" [filter]="true"
                    filterPlaceholder="Search proxies..." class="w-full">
                    <ng-template let-proxy pTemplate="item">
                        <div class="flex items-center gap-3">
                            <i class="pi pi-globe text-xs text-primary"></i>
                            <div class="flex flex-col">
                                <span class="text-sm font-medium">{{ proxy.host }}:{{ proxy.port }}</span>
                                <span class="text-xs text-muted-color">{{ proxy.type | uppercase }} {{ proxy.group ? '•
                                    ' + proxy.group : '' }}</span>
                            </div>
                            @if (proxy.isAlive !== null && proxy.isAlive !== undefined) {
                            <span class="ml-auto">
                                <i
                                    [class]="proxy.isAlive ? 'pi pi-circle-fill text-green-500 text-xs' : 'pi pi-circle-fill text-red-500 text-xs'"></i>
                            </span>
                            }
                        </div>
                    </ng-template>
                </p-select>

                @if (selectedProxyId()) {
                <div class="flex items-center gap-2">
                    <p-button icon="pi pi-sync" label="Check" [outlined]="true" size="small" [loading]="checkingProxy()"
                        (click)="checkProxyInline()" />
                    @if (proxyCheckResult(); as result) {
                    <span class="flex items-center gap-1.5 text-xs font-medium"
                        [class]="result.isAlive ? 'text-green-500' : 'text-red-500'">
                        <i [class]="result.isAlive ? 'pi pi-check-circle' : 'pi pi-times-circle'"></i>
                        {{ result.isAlive ? 'Online ' + result.latencyMs + 'ms' : 'Offline' }}
                    </span>
                    }
                </div>
                }
            </div>
            }

            <!-- Manual Proxy Input -->
            @if (proxyMode() === 'manual') {
            <div class="space-y-3">
                <!-- Type -->
                <div class="flex gap-1">
                    @for (opt of proxyTypeOptions; track opt.value) {
                    <button class="flex-1 px-3 py-1.5 text-xs font-medium rounded border transition-all" [class]="manualProxyType() === opt.value
                            ? 'bg-primary border-primary text-white'
                            : 'border-surface text-muted-color hover:border-primary'"
                        (click)="manualProxyType.set($any(opt.value))">
                        {{ opt.label }}
                    </button>
                    }
                </div>

                <!-- Host + Port -->
                <div class="flex gap-3">
                    <div class="flex-1">
                        <input pInputText [ngModel]="manualProxyHost()" (ngModelChange)="manualProxyHost.set($event)"
                            placeholder="Host (e.g., 31.59.20.176)" class="w-full" />
                    </div>
                    <div class="w-24">
                        <input pInputText type="number" [ngModel]="manualProxyPort()"
                            (ngModelChange)="manualProxyPort.set($event)" placeholder="Port" class="w-full" />
                    </div>
                </div>

                <!-- Username + Password (optional, not supported for SOCKS4) -->
                <div class="flex gap-3" [class.opacity-40]="manualProxyType() === 'socks4'"
                    [class.pointer-events-none]="manualProxyType() === 'socks4'">
                    <div class="flex-1">
                        <input pInputText [ngModel]="manualProxyUsername()"
                            (ngModelChange)="manualProxyUsername.set($event)" placeholder="Username (optional)"
                            class="w-full" [disabled]="manualProxyType() === 'socks4'" />
                    </div>
                    <div class="flex-1">
                        <input pInputText type="password" [ngModel]="manualProxyPassword()"
                            (ngModelChange)="manualProxyPassword.set($event)" placeholder="Password (optional)"
                            class="w-full" [disabled]="manualProxyType() === 'socks4'" />
                    </div>
                </div>
                @if (manualProxyType() === 'socks4') {
                <p class="text-xs text-yellow-600 dark:text-yellow-400 flex items-center gap-1">
                    <i class="pi pi-info-circle"></i>
                    SOCKS4 does not support authentication
                </p>
                }

                <!-- Check button -->
                @if (manualProxyHost() && manualProxyPort()) {
                <div class="flex items-center gap-2">
                    <p-button icon="pi pi-sync" label="Check" [outlined]="true" size="small" [loading]="checkingProxy()"
                        (click)="checkProxyInline()" />
                    @if (proxyCheckResult(); as result) {
                    <span class="flex items-center gap-1.5 text-xs font-medium"
                        [class]="result.isAlive ? 'text-green-500' : 'text-red-500'">
                        <i [class]="result.isAlive ? 'pi pi-check-circle' : 'pi pi-times-circle'"></i>
                        {{ result.isAlive ? 'Online ' + result.latencyMs + 'ms' : 'Offline' }}
                    </span>
                    }
                </div>
                }
            </div>
            }
        </div>

        <!-- Custom Chrome Flags -->
        <div id="home-edit-dialog-flags-section">
            <label for="home-edit-dialog-flags-input" class="block text-xs font-medium text-color mb-2">Custom Chrome
                Flags</label>
            <input id="home-edit-dialog-flags-input" pInputText type="text" [ngModel]="editCustomFlags()"
                (ngModelChange)="editCustomFlags.set($event)" placeholder="--disable-gpu --no-sandbox" class="w-full" />
            <p class="text-xs text-muted-color mt-1">Space-separated flags passed to browser on launch (e.g.,
                --disable-gpu)</p>
        </div>

        <!-- Feature 2.5: Folder Management -->
        <div id="home-edit-dialog-folder-section">
            <label for="home-edit-dialog-folder-select" class="block text-xs font-medium text-color mb-2">Folder</label>
            <p-select id="home-edit-dialog-folder-select" [options]="customFolderOptions()" optionLabel="name"
                optionValue="id" [ngModel]="editFolderId()" (ngModelChange)="editFolderId.set($event)"
                placeholder="No folder" [showClear]="true" class="w-full" />
            <p class="text-xs text-muted-color mt-1">Organize this profile into a folder</p>
        </div>

        <!-- Feature 3.4: Disable Extensions -->
        <div id="home-edit-dialog-extensions-section" class="flex items-center justify-between">
            <div>
                <label class="block text-xs font-medium text-color">Disable Extensions on Launch</label>
                <p class="text-xs text-muted-color">Launch browser with all extensions disabled</p>
            </div>
            <p-toggleSwitch id="home-edit-dialog-extensions-toggle" [ngModel]="editDisableExtensions()"
                (ngModelChange)="editDisableExtensions.set($event)" />
        </div>

        <!-- Antidetect: Privacy Mode -->
        <div id="home-edit-dialog-privacy-section"
            class="space-y-2 p-3 rounded-lg border border-surface-200 dark:border-surface-700">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-2">
                    <i class="pi pi-shield text-primary"></i>
                    <div>
                        <label for="home-edit-dialog-privacy-toggle"
                            class="block text-xs font-medium text-color">Privacy Mode</label>
                        <p class="text-xs text-muted-color">Disable telemetry, sync, WebRTC leak &amp; tracking</p>
                    </div>
                </div>
                <p-toggleSwitch id="home-edit-dialog-privacy-toggle" [ngModel]="editAntidetectEnabled()"
                    (ngModelChange)="editAntidetectEnabled.set($event)" />
            </div>
            @if (editAntidetectEnabled()) {
            <div class="text-xs text-muted-color pt-1 border-t border-surface-100 dark:border-surface-800 space-y-1">
                <p class="font-medium text-color">Active flags (10):</p>
                <ul class="list-disc list-inside space-y-0.5">
                    <li>Disable background networking</li>
                    <li>Disable phishing detection</li>
                    <li>Disable domain reliability</li>
                    <li>Disable crash reporting</li>
                    <li>Disable ping tracking</li>
                    <li>Disable WebRTC event logging</li>
                    <li>Block WebRTC IP leak</li>
                    <li>Disable metrics recording</li>
                    <li>Disable component updates</li>
                    <li>Disable sync</li>
                </ul>
            </div>
            }
        </div>

        <!-- Camoufox Engine Selector -->
        <div id="home-edit-dialog-engine-section"
            class="space-y-3 p-3 rounded-lg border border-surface-200 dark:border-surface-700">
            <div class="flex items-center gap-2 mb-2">
                <i class="pi pi-cog text-primary"></i>
                <div>
                    <label class="block text-xs font-medium text-color">Browser Engine</label>
                    <p class="text-xs text-muted-color">Choose Chrome or Camoufox (antidetect Firefox)</p>
                </div>
            </div>
            <div class="flex gap-2">
                @for (engine of engineOptions; track engine.value) {
                <button id="home-edit-dialog-engine-{{ engine.value }}" type="button"
                    class="flex-1 flex items-center justify-center gap-2 px-3 py-2 rounded-lg border text-xs font-medium transition-all cursor-pointer"
                    [class]="editBrowserEngine() === engine.value
                        ? 'border-primary bg-primary/10 text-primary dark:bg-primary/20'
                        : 'border-surface-200 dark:border-surface-700 text-muted-color hover:border-primary/50'"
                    (click)="editBrowserEngine.set(engine.value)">
                    <i [class]="engine.icon"></i>
                    {{ engine.label }}
                </button>
                }
            </div>

            @if (editBrowserEngine() === 'camoufox') {
            <div class="space-y-2 pt-2 border-t border-surface-100 dark:border-surface-800">
                @if (!camoufoxService.isInstalled()) {
                <div
                    class="flex items-center gap-2 p-2 rounded-lg bg-yellow-50 dark:bg-yellow-900/20 text-yellow-700 dark:text-yellow-400 text-xs">
                    <i class="pi pi-exclamation-triangle"></i>
                    <span>Camoufox not installed.</span>
                    <button type="button"
                        class="ml-auto px-2 py-1 rounded bg-primary text-white text-xs font-medium cursor-pointer"
                        [disabled]="camoufoxService.isDownloading()" (click)="camoufoxService.download()">
                        @if (camoufoxService.isDownloading()) {
                        <i class="pi pi-spinner pi-spin mr-1"></i> {{ camoufoxService.downloadProgress() }}%
                        } @else {
                        <i class="pi pi-download mr-1"></i> Install
                        }
                    </button>
                </div>
                } @else {
                <!-- Fingerprint OS selector -->
                <div class="flex items-center gap-2">
                    <label class="text-xs font-medium text-color whitespace-nowrap">Target OS:</label>
                    <div class="flex gap-1.5">
                        @for (osOpt of [
                        {label: 'Windows', value: 'windows', icon: 'pi pi-microsoft'},
                        {label: 'macOS', value: 'macos', icon: 'pi pi-apple'},
                        {label: 'Linux', value: 'linux', icon: 'pi pi-server'}
                        ]; track osOpt.value) {
                        <button id="home-edit-dialog-fp-os-{{ osOpt.value }}" type="button"
                            class="px-2 py-1 rounded text-xs transition-all cursor-pointer"
                            [class]="editFingerprintOs() === osOpt.value
                                ? 'bg-primary/10 text-primary border border-primary dark:bg-primary/20'
                                : 'border border-surface-200 dark:border-surface-700 text-muted-color hover:border-primary/50'"
                            (click)="editFingerprintOs.set(editFingerprintOs() === osOpt.value ? null : osOpt.value)">
                            <i [class]="osOpt.icon + ' mr-1'"></i>{{ osOpt.label }}
                        </button>
                        }
                    </div>
                </div>
                <p class="text-xs text-muted-color">
                    <i class="pi pi-info-circle mr-1"></i>
                    Fingerprint is auto-generated on each launch. Select OS to control spoofed platform.
                </p>
                }
            </div>
            }
        </div>

        <!-- Feature 4.2: Proxy Rotation -->
        <div id="home-edit-dialog-proxy-rotation-section"
            class="space-y-3 p-3 rounded-lg border border-surface-200 dark:border-surface-700">
            <div class="flex items-center justify-between">
                <div>
                    <label class="block text-xs font-medium text-color">Proxy Rotation</label>
                    <p class="text-xs text-muted-color">Auto-rotate proxy for this profile</p>
                </div>
                <p-toggleSwitch id="home-edit-dialog-proxy-rotation-toggle" [ngModel]="editProxyRotationEnabled()"
                    (ngModelChange)="editProxyRotationEnabled.set($event)" />
            </div>
            @if (editProxyRotationEnabled()) {
            <div class="space-y-3 pt-2 border-t border-surface-100 dark:border-surface-800">
                <div>
                    <label for="home-edit-dialog-rotation-mode"
                        class="block text-xs font-medium text-color mb-1">Rotation Mode</label>
                    <p-select id="home-edit-dialog-rotation-mode" [options]="proxyRotationModeOptions"
                        optionLabel="label" optionValue="value" [ngModel]="editProxyRotationMode()"
                        (ngModelChange)="editProxyRotationMode.set($event)" class="w-full" />
                </div>
                @if (proxyGroups().length > 0) {
                <div>
                    <label for="home-edit-dialog-rotation-group" class="block text-xs font-medium text-color mb-1">Proxy
                        Group (Optional)</label>
                    <p-select id="home-edit-dialog-rotation-group" [options]="proxyGroups()"
                        [ngModel]="editProxyRotationGroupId()" (ngModelChange)="editProxyRotationGroupId.set($event)"
                        placeholder="All proxies" [showClear]="true" class="w-full" />
                </div>
                }
            </div>
            }
        </div>

        <!-- Notes -->
        <div id="home-edit-dialog-notes-section">
            <label for="home-edit-dialog-notes-input" class="block text-xs font-medium text-color mb-2">Notes</label>
            <textarea pTextarea id="home-edit-dialog-notes-input" [ngModel]="editNotes()"
                (ngModelChange)="editNotes.set($event)" placeholder="What is this profile for?" rows="2"
                class="w-full resize-none"></textarea>
        </div>
    </div>
    <ng-template #footer>
        <div id="home-edit-dialog-footer" class="flex justify-end gap-3 pt-2">
            <p-button id="home-edit-dialog-cancel-btn" label="Cancel" severity="secondary" (click)="onCancel()" />
            <p-button id="home-edit-dialog-submit-btn" label="Save" (click)="onSave()" />
        </div>
    </ng-template>
</p-dialog>