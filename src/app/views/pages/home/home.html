<!-- Sidebar (responsive: drawer on mobile, static on desktop) - Hidden in Zen Mode -->
@if (!zenMode()) {
<app-home-sidebar [folders]="folders()" [selectedFolderId]="selectedFolderId()" [isOpen]="sidebarOpen()"
    (folderSelected)="onFolderSelected($event)" (addFolderClicked)="onAddFolder()" (settingsClicked)="onSettings()"
    (folderSettingsClicked)="openManageFolders()" (closeSidebar)="sidebarOpen.set(false)" />
}

<!-- Main Content -->
<div id="home-container" class="flex-1 flex flex-col min-h-0 text-color overflow-hidden border-t border-surface">
    <!-- Header Toolbar -->
    <app-profile-toolbar [searchText]="searchText()" [viewMode]="viewMode()" [sortBy]="sortBy()"
        [sortOrder]="sortOrder()" [selectedCount]="selectedProfiles().length" [uniqueGroups]="uniqueGroups()"
        [filterGroup]="filterGroup()" [activeFilterCount]="activeFilterCount()" [showHidden]="showHidden()"
        [filterFavoritesOnly]="filterFavoritesOnly()" [favoriteCount]="favoriteCount()" [compactMode]="compactMode()"
        [todayActivityCount]="activityLog.todayEntries().length" (searchChange)="onSearchInput($event)"
        (viewModeChange)="viewMode.set($event)" (sortByChange)="sortBy.set($event)"
        (sortOrderChange)="sortOrder.set($event)" (filterGroupChange)="setFilterGroup($event)"
        (showHiddenChange)="showHidden.set($event)" (filterFavoritesOnlyChange)="filterFavoritesOnly.set($event)"
        (compactModeChange)="toggleCompactMode()" (scan)="scanProfiles()" (create)="openCreateDialog()"
        (openSidebar)="sidebarOpen.set(true)" (showActivityLog)="showActivityLog.set(true)"
        (restoreFromBackup)="restoreFromBackup()" (clearFilters)="clearFilters()" (exportProfiles)="exportProfiles()"
        (importProfiles)="importProfiles()" />

    <!-- Tabs (scrollable on mobile) -->
    <div id="home-tabs"
        class="flex items-center justify-between px-3 sm:px-6 py-2 sm:py-3 border-b border-surface shrink-0">
        <nav id="home-tabs-nav"
            class="flex items-center gap-3 sm:gap-6 overflow-x-auto scrollbar-hide whitespace-nowrap">
            @for (tab of tabs; track tab.key; let i = $index) {
            <button [id]="'home-tab-' + i"
                class="flex items-center gap-1.5 sm:gap-2 pb-2 text-xs sm:text-sm font-medium transition-colors border-b-2 -mb-[9px] sm:-mb-[13px] shrink-0"
                [class]="activeTab() === tab.key
            ? 'text-color border-primary'
            : 'text-muted-color border-transparent hover:text-muted-color'" (click)="setActiveTab(tab.key)">
                <i [class]="'pi ' + tab.icon + ' text-xs sm:text-sm'"></i>
                <span class="hidden sm:inline">{{ tab.label }}</span>
            </button>
            }
        </nav>
        <span id="home-tabs-usage" class="text-xs sm:text-sm text-muted-color shrink-0 ml-2">{{ profilesUsed() }} / {{
            maxProfiles() }}</span>
    </div>

    <!-- Content -->
    <div id="home-content" class="flex-1 min-h-0" [class.overflow-hidden]="viewMode() === 'table'"
        [class.overflow-auto]="viewMode() !== 'table'">
        @if (loading()) {
        <div id="home-loading" class="flex flex-col items-center justify-center py-16 gap-4 text-muted-color">
            <p-progressSpinner strokeWidth="3" />
            <p>Scanning profiles...</p>
        </div>
        } @else if (profiles().length === 0) {
        <div id="home-empty" class="flex flex-col items-center justify-center py-16 text-center">
            <div id="home-empty-icon"
                class="w-20 h-20 rounded-2xl border border-surface flex items-center justify-center mb-5">
                <i class="pi pi-inbox text-3xl text-zinc-400"></i>
            </div>
            <h3 id="home-empty-title" class="text-lg font-semibold text-color mb-2">No
                Profiles Found</h3>
            <p id="home-empty-desc" class="text-sm text-muted-color">Enter the path to your Chrome
                profiles folder and
                click Scan</p>
        </div>
        } @else if (filteredProfiles().length === 0 && hasActiveFilters()) {
        <!-- No search results -->
        <div id="home-no-results" class="flex flex-col items-center justify-center py-16 text-center">
            <div class="w-20 h-20 rounded-2xl border border-surface flex items-center justify-center mb-5">
                <i class="pi pi-search text-3xl text-zinc-400"></i>
            </div>
            <h3 class="text-lg font-semibold text-color mb-2">No Matching Profiles</h3>
            <p class="text-sm text-muted-color mb-4">Try adjusting your search or filters</p>
            <button (click)="clearFilters()"
                class="px-4 py-2 bg-primary text-white text-sm font-medium rounded-lg hover:bg-primary-hover transition-colors">
                Clear filters
            </button>
        </div>
        } @else if (activeTab() === 'profiles') {

        <!-- Profiles View - Table or Grid -->
        @if (viewMode() === 'table') {
        <!-- Profiles Table with Virtual Scrolling -->
        <p-table id="home-profiles-table" [value]="paginatedProfiles()" [(selection)]="selectedProfiles"
            (selectionChange)="onSelectionChange($event)" dataKey="path" [scrollable]="true" scrollHeight="flex"
            [resizableColumns]="true" columnResizeMode="expand" [sortField]="sortBy()"
            [sortOrder]="sortOrder() === 'asc' ? 1 : -1" (onSort)="onTableSort($event)">

            <!-- Header -->
            <ng-template pTemplate="header">
                <tr id="home-profiles-table-header">
                    <th style="width: 3rem"><p-tableHeaderCheckbox /></th>
                    <th style="width: 3rem"><i class="pi pi-star"></i></th>
                    <th pResizableColumn pSortableColumn="name">Name <p-sortIcon field="name" /></th>
                    <th pResizableColumn>Status</th>
                    <th pResizableColumn pSortableColumn="metadata.proxy">Proxy <p-sortIcon field="metadata.proxy" />
                    </th>
                    <th pResizableColumn>Tags</th>
                    <th pResizableColumn>Notes</th>
                    <th pResizableColumn pSortableColumn="metadata.lastOpened">Last Changed <p-sortIcon
                            field="metadata.lastOpened" /></th>
                    <th pResizableColumn>Running Time</th>
                    <th style="width: 3rem"><i class="pi pi-cog"></i></th>
                </tr>
            </ng-template>

            <!-- Body -->
            <ng-template pTemplate="body" let-profile let-i="rowIndex">
                <tr [id]="'home-profile-row-' + i" (click)="openEditDialog(profile, $event)" style="cursor: pointer">
                    <!-- Checkbox -->
                    <td (click)="$event.stopPropagation()">
                        <p-tableCheckbox [value]="profile" />
                    </td>

                    <!-- Pin -->
                    <td>
                        <button [id]="'home-profile-' + i + '-pin-btn'" (click)="togglePin(profile, $event)"
                            class="w-7 h-7 rounded-md transition-colors flex items-center justify-center" [class]="profile.metadata?.isPinned 
                                     ? 'text-yellow-400 hover:text-yellow-300' 
                                     : 'text-muted-color hover:text-zinc-400'">
                            <i [class]="profile.metadata?.isPinned ? 'pi pi-star-fill' : 'pi pi-star'"></i>
                        </button>
                    </td>

                    <!-- Name with Start button -->
                    <td>
                        <div class="flex items-center gap-3">
                            <!-- Phase 1: Color dot -->
                            @if (profile.metadata?.color) {
                            <span class="w-3 h-3 rounded-full flex-shrink-0"
                                [style.background-color]="profile.metadata.color"></span>
                            }
                            <p-button [id]="'home-profile-' + i + '-start-btn'" (click)="launchProfile(profile, $event)"
                                [icon]="'pi ' + getOsIcon(profile)" label="Start" size="small" [outlined]="true" />
                            <span [class]="profile.metadata?.isHidden ? 'opacity-50' : ''"
                                [pTooltip]="getProfileTooltip(profile)" tooltipPosition="right" [escape]="false">{{
                                profile.name }}</span>
                            <!-- Phase 2: Hidden indicator -->
                            @if (profile.metadata?.isHidden) {
                            <i class="pi pi-eye-slash text-xs text-muted-color" pTooltip="Hidden profile"></i>
                            }
                        </div>
                    </td>

                    <!-- Status -->
                    <td>
                        <span class="px-2.5 py-1 border border-surface rounded text-xs text-muted-color">
                            No status
                        </span>
                    </td>

                    <!-- Proxy -->
                    <td>
                        @if (profile.metadata?.proxy) {
                        <span
                            class="inline-flex items-center gap-1.5 px-2.5 py-1 bg-surface-100 dark:bg-surface-800 border border-surface rounded text-xs text-color font-mono"
                            [pTooltip]="profile.metadata?.proxy" tooltipPosition="top">
                            <i class="pi pi-globe text-[10px] text-primary"></i>
                            <span class="max-w-[120px] truncate">{{ profile.metadata?.proxy }}</span>
                        </span>
                        } @else {
                        <p-button [id]="'home-profile-' + i + '-proxy-btn'" icon="pi pi-plus" [rounded]="true"
                            [text]="true" severity="secondary" size="small" (click)="openEditDialog(profile, $event)"
                            pTooltip="Add Proxy" />
                        }
                    </td>

                    <!-- Tags -->
                    <td>
                        @if (profile.metadata?.tags && profile.metadata.tags.length > 0) {
                        <div class="flex flex-wrap gap-1">
                            @for (tag of profile.metadata.tags.slice(0, 3); track tag) {
                            <span
                                class="px-2 py-0.5 bg-primary/20 border border-primary/40 rounded text-xs text-primary">
                                {{ tag }}
                            </span>
                            }
                            @if (profile.metadata.tags.length > 3) {
                            <span class="px-2 py-0.5 border border-surface rounded text-xs text-color">
                                +{{ profile.metadata.tags.length - 3 }}
                            </span>
                            }
                        </div>
                        } @else {
                        <p-button [id]="'home-profile-' + i + '-tags-btn'" icon="pi pi-plus" [rounded]="true"
                            [text]="true" severity="secondary" size="small" />
                        }
                    </td>

                    <!-- Notes -->
                    <td>
                        @if (profile.metadata?.notes) {
                        <span
                            class="inline-flex items-center gap-1.5 px-2.5 py-1 bg-note-yellow/20 border border-note-yellow/40 rounded text-xs text-note-yellow">
                            <i class="pi pi-pencil text-[10px]"></i>
                            <span class="max-w-[100px] truncate">{{ profile.metadata?.notes }}</span>
                        </span>
                        } @else {
                        <p-button [id]="'home-profile-' + i + '-notes-btn'" icon="pi pi-plus" [rounded]="true"
                            [text]="true" severity="secondary" size="small" />
                        }
                    </td>

                    <!-- Last Changed (Feature 11.4) -->
                    <td>
                        <span class="text-xs text-muted-color whitespace-nowrap">{{
                            formatRelativeDate(profile.metadata?.lastOpened) }}</span>
                    </td>

                    <!-- Running Time (Feature 11.5) -->
                    <td>
                        @if (profile.metadata?.totalUsageMinutes) {
                        <span
                            class="inline-flex items-center gap-1 px-2 py-0.5 bg-surface-100 dark:bg-surface-800 rounded text-xs text-color">
                            <i class="pi pi-clock text-[10px] text-muted-color"></i>
                            {{ formatMinutes(profile.metadata.totalUsageMinutes) }}
                        </span>
                        } @else {
                        <span class="text-xs text-muted-color">-</span>
                        }
                    </td>

                    <!-- Actions -->
                    <td>
                        <div class="flex items-center gap-1">
                            <p-button [id]="'home-profile-' + i + '-incognito-btn'"
                                (click)="launchProfileIncognito(profile, $event)" icon="pi pi-eye-slash"
                                [rounded]="true" [text]="true" severity="secondary" size="small"
                                pTooltip="Launch in Incognito" />
                            <p-button [id]="'home-profile-' + i + '-duplicate-btn'"
                                (click)="openDuplicateDialog(profile, $event)" icon="pi pi-copy" [rounded]="true"
                                [text]="true" severity="secondary" size="small" pTooltip="Duplicate profile" />
                            <p-button [id]="'home-profile-' + i + '-backup-btn'"
                                (click)="backupProfile(profile, $event)" icon="pi pi-download" [rounded]="true"
                                [text]="true" severity="secondary" size="small" pTooltip="Backup to ZIP" />
                            <!-- Phase 2: Hide toggle -->
                            <p-button [id]="'home-profile-' + i + '-hide-btn'" (click)="toggleHide(profile, $event)"
                                [icon]="profile.metadata?.isHidden ? 'pi pi-eye' : 'pi pi-eye-slash'" [rounded]="true"
                                [text]="true" severity="secondary" size="small"
                                [pTooltip]="profile.metadata?.isHidden ? 'Show profile' : 'Hide profile'" />
                            <!-- Feature 2.4: Favorites toggle -->
                            <p-button [id]="'home-profile-' + i + '-favorite-btn'"
                                (click)="toggleFavorite(profile, $event)"
                                [icon]="profile.metadata?.isFavorite ? 'pi pi-heart-fill' : 'pi pi-heart'"
                                [rounded]="true" [text]="true"
                                [severity]="profile.metadata?.isFavorite ? 'danger' : 'secondary'" size="small"
                                [pTooltip]="profile.metadata?.isFavorite ? 'Remove from Favorites' : 'Add to Favorites'" />
                            <!-- Feature 4.2: Clear Cookies -->
                            <p-button [id]="'home-profile-' + i + '-clear-cookies-btn'"
                                (click)="clearCookies(profile, $event)" icon="pi pi-eraser" [rounded]="true"
                                [text]="true" severity="secondary" size="small" pTooltip="Clear cookies & cache" />
                            <p-button [id]="'home-profile-' + i + '-delete-btn'"
                                (click)="deleteProfile(profile, $event)" icon="pi pi-trash" [rounded]="true"
                                [text]="true" severity="danger" size="small" pTooltip="Delete profile" />
                        </div>
                    </td>
                </tr>
            </ng-template>

            <!-- Empty state -->
            <ng-template pTemplate="emptymessage">
                <tr>
                    <td colspan="10">No profiles in this folder</td>
                </tr>
            </ng-template>
        </p-table>


        } @else {
        <!-- Grid View -->
        <!-- Feature 6.7: Compact mode adds more columns -->
        <div id="home-profiles-grid" [class]="compactMode() 
                ? 'grid grid-cols-4 md:grid-cols-6 lg:grid-cols-8 xl:grid-cols-10 gap-2' 
                : 'grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4'" cdkDropList
            [cdkDropListDisabled]="sortBy() !== 'custom'" (cdkDropListDropped)="onProfileDrop($event)">
            @for (profile of paginatedProfiles(); track profile.path; let i = $index) {
            <div [id]="'home-profile-card-' + i"
                [class]="compactMode() 
                    ? 'border border-surface rounded-lg p-2 hover:border-primary/50 transition-all duration-300 cursor-pointer relative group shadow-sm hover:shadow-md'
                    : 'border border-surface rounded-xl p-4 hover:border-primary/50 transition-all duration-300 cursor-pointer relative group shadow-sm hover:shadow-md'"
                [class.hover:-translate-y-1]="sortBy() !== 'custom'" [class.cursor-grab]="sortBy() === 'custom'" cdkDrag
                [cdkDragDisabled]="sortBy() !== 'custom'" (click)="openEditDialog(profile, $event)"
                [pTooltip]="getProfileTooltip(profile)" tooltipPosition="top" [escape]="false">
                <!-- Drag Handle indicator (only in custom sort mode) -->
                @if (sortBy() === 'custom') {
                <div
                    class="absolute top-2 right-2 text-muted-color opacity-0 group-hover:opacity-100 transition-opacity">
                    <i class="pi pi-arrows-alt text-xs"></i>
                </div>
                }
                <!-- Phase 0: Proxy Indicator (Grid) -->
                @if (profile.metadata?.proxy) {
                <div class="absolute top-2 right-2 z-10"
                    [class.right-8]="profile.metadata?.isPinned && sortBy() !== 'custom'">
                    <span
                        class="w-6 h-6 rounded-full bg-surface-0/80 dark:bg-surface-900/80 backdrop-blur-sm shadow-sm flex items-center justify-center border border-surface"
                        [pTooltip]="'Proxy: ' + profile.metadata?.proxy" tooltipPosition="left">
                        <i class="pi pi-globe text-primary text-xs"></i>
                    </span>
                </div>
                }
                <!-- Phase 1: Color indicator -->
                @if (profile.metadata?.color) {
                <div class="absolute top-2 left-2">
                    <span class="w-3 h-3 rounded-full inline-block"
                        [style.background-color]="profile.metadata?.color"></span>
                </div>
                }
                <!-- Pin indicator -->
                @if (profile.metadata?.isPinned && sortBy() !== 'custom') {
                <div class="absolute top-2 right-2">
                    <i class="pi pi-star-fill text-yellow-400 text-xs"></i>
                </div>
                }
                <!-- Phase 2: Hidden indicator -->
                @if (profile.metadata?.isHidden) {
                <div class="absolute top-2" [class]="profile.metadata?.color ? 'left-7' : 'left-2'">
                    <i class="pi pi-eye-slash text-muted-color text-xs"></i>
                </div>
                }
                <!-- Avatar/Emoji -->
                <div class="w-14 h-14 rounded-xl flex items-center justify-center mb-3 text-2xl"
                    [class]="profile.metadata?.isHidden ? 'opacity-50' : ''">
                    {{ getProfileDisplay(profile) }}
                </div>
                <!-- Name -->
                <h3 class="text-sm font-semibold text-color mb-1 truncate"
                    [class]="profile.metadata?.isHidden ? 'opacity-50' : ''">
                    {{ profile.name }}
                </h3>
                <!-- Tags -->
                @if (profile.metadata?.tags?.length) {
                <div class="flex flex-wrap gap-1 mb-2">
                    @for (tag of profile.metadata!.tags!.slice(0, 2); track tag) {
                    <span class="px-2 py-0.5 bg-primary/20 text-primary text-xs rounded">{{ tag }}</span>
                    }
                </div>
                }
                <!-- Actions -->
                <div class="flex items-center gap-2 mt-3 opacity-0 group-hover:opacity-100 transition-opacity">
                    <p-button (click)="launchProfile(profile, $event)" label="Start" size="small" class="flex-1" />
                    <button (click)="openDuplicateDialog(profile, $event)"
                        class="p-1.5 text-muted-color hover:text-primary transition-colors" title="Duplicate">
                        <i class="pi pi-copy text-sm"></i>
                    </button>
                    <button (click)="backupProfile(profile, $event)"
                        class="p-1.5 text-muted-color hover:text-primary transition-colors" title="Backup to ZIP">
                        <i class="pi pi-download text-sm"></i>
                    </button>
                    <!-- Feature 2.4: Favorites toggle -->
                    <button (click)="toggleFavorite(profile, $event)" [class]="profile.metadata?.isFavorite 
                            ? 'p-1.5 text-red-500 hover:text-red-400 transition-colors' 
                            : 'p-1.5 text-muted-color hover:text-red-500 transition-colors'"
                        [title]="profile.metadata?.isFavorite ? 'Remove from Favorites' : 'Add to Favorites'">
                        <i
                            [class]="profile.metadata?.isFavorite ? 'pi pi-heart-fill text-sm' : 'pi pi-heart text-sm'"></i>
                    </button>
                    <button (click)="deleteProfile(profile, $event)"
                        class="p-1.5 text-muted-color hover:text-error transition-colors" title="Delete">
                        <i class="pi pi-trash text-sm"></i>
                    </button>
                </div>

                <!-- CDK Drag Placeholder -->
                <div *cdkDragPlaceholder
                    class="border-2 border-dashed border-primary/50 rounded-xl bg-primary/5 h-full"></div>
            </div>
            }
        </div>
        }
        } @else {
        <!-- Other tabs placeholder -->
        <div id="home-tab-placeholder" class="flex flex-col items-center justify-center py-16 text-center">
            <div id="home-tab-placeholder-icon"
                class="w-16 h-16 rounded-xl border border-surface flex items-center justify-center mb-4">
                <i class="pi pi-cog text-2xl text-zinc-400"></i>
            </div>
            <h3 id="home-tab-placeholder-title" class="text-lg font-semibold text-color mb-2">
                {{ activeTab() |
                titlecase }}</h3>
            <p id="home-tab-placeholder-desc" class="text-sm text-muted-color">Coming soon...</p>
        </div>
        }
    </div>

    <!-- Bottom Bar (Always visible with paginator, actions appear when selection) -->
    @if (activeTab() === 'profiles' && filteredProfiles().length > 0) {
    <div id="home-bottom"
        class="shrink-0 border-t border-surface px-4 py-3 min-h-[49px] sticky bottom-0 bg-surface-0 dark:bg-surface-900 z-10">
        <div class="flex items-center justify-between gap-4">
            <!-- Left: Actions (only when selection) -->
            @if (selectedProfiles().length > 0) {
            <div id="home-bottom-actions" class="flex items-center gap-2">
                <span id="home-bottom-selected-count" class="text-sm font-medium text-primary">
                    {{ selectedProfiles().length }} selected
                </span>
                <div class="w-px h-5 bg-border"></div>
                <button id="home-bottom-start-all-btn" (click)="bulkLaunch()"
                    class="h-7 flex items-center gap-1.5 px-2.5 rounded border border-primary text-primary hover:bg-primary hover:text-white transition-colors text-xs font-medium"
                    title="Launch all selected">
                    <i class="pi pi-play text-xs"></i>
                    <span class="hidden sm:inline">Launch</span>
                </button>
                <button id="home-bottom-export-btn" (click)="bulkExport()"
                    class="h-7 flex items-center gap-1.5 px-2.5 rounded border border-blue-500 text-blue-500 hover:bg-blue-500 hover:text-white transition-colors text-xs font-medium"
                    title="Export selected to ZIP">
                    <i class="pi pi-download text-xs"></i>
                    <span class="hidden sm:inline">Export</span>
                </button>
                <button id="home-bottom-tags-btn" (click)="openMassTagDialog()"
                    class="h-7 flex items-center gap-1.5 px-2.5 rounded border border-purple-500 text-purple-500 hover:bg-purple-500 hover:text-white transition-colors text-xs font-medium"
                    title="Assign tags to selected">
                    <i class="pi pi-tag text-xs"></i>
                    <span class="hidden sm:inline">Tags</span>
                </button>
                <button id="home-bottom-delete-btn" (click)="bulkDelete()"
                    class="h-7 flex items-center gap-1.5 px-2.5 rounded border border-error text-error hover:bg-error hover:text-white transition-colors text-xs font-medium"
                    title="Delete selected">
                    <i class="pi pi-trash text-xs"></i>
                    <span class="hidden sm:inline">Delete</span>
                </button>
                <button id="home-bottom-clear-btn" (click)="clearSelection()"
                    class="w-7 h-7 rounded border border-surface text-muted-color hover:text-color transition-colors flex items-center justify-center"
                    title="Clear selection">
                    <i class="pi pi-times text-xs"></i>
                </button>
            </div>
            } @else {
            <div></div>
            }

            <!-- Right: Minimal Paginator -->
            <div id="home-bottom-paginator" class="flex items-center gap-3 text-sm">
                <span class="text-muted-color">Rows per page:</span>
                <p-select
                    [options]="[{label: '10', value: 10}, {label: '25', value: 25}, {label: '50', value: 50}, {label: '100', value: 100}, {label: '500', value: 500}]"
                    [ngModel]="rowsPerPage()" (ngModelChange)="onRowsPerPageChange($event)" optionLabel="label"
                    optionValue="value" [style]="{'min-width': '5rem'}" />
                <span class="text-muted-color">{{ first() + 1 }}-{{ Math.min(first() + rowsPerPage(),
                    filteredProfiles().length) }} of {{ filteredProfiles().length }}</span>
                <div class="flex items-center">
                    <button (click)="onPagePrev()" [disabled]="first() === 0"
                        class="w-7 h-7 flex items-center justify-center text-muted-color hover:text-color disabled:opacity-30 disabled:cursor-not-allowed transition-colors">
                        <i class="pi pi-chevron-left text-xs"></i>
                    </button>
                    <button (click)="onPageNext()" [disabled]="first() + rowsPerPage() >= filteredProfiles().length"
                        class="w-7 h-7 flex items-center justify-center text-muted-color hover:text-color disabled:opacity-30 disabled:cursor-not-allowed transition-colors">
                        <i class="pi pi-chevron-right text-xs"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
    }

    <!-- Create Profile Dialog -->
    <p-dialog id="home-create-dialog" header="Create New Profile" [(visible)]="showCreateDialog" [modal]="true"
        [style]="{ width: 'min(400px, 95vw)' }" [draggable]="false" [resizable]="false">
        <div id="home-create-dialog-content">
            <label for="home-create-dialog-name-input">Profile Name</label>
            <input pInputText id="home-create-dialog-name-input" type="text" [ngModel]="newProfileName()"
                (ngModelChange)="newProfileName.set($event)" placeholder="e.g., Work, Personal" class="w-full" />
        </div>
        <ng-template #footer>
            <p-button id="home-create-dialog-cancel-btn" label="Cancel" severity="secondary"
                (click)="showCreateDialog.set(false)" />
            <p-button id="home-create-dialog-submit-btn" label="Create" (click)="createProfile()" />
        </ng-template>
    </p-dialog>

    <!-- Rename Profile Dialog -->
    <p-dialog id="home-rename-dialog" header="Rename Profile" [(visible)]="showRenameDialog" [modal]="true"
        [style]="{ width: 'min(400px, 95vw)' }" [draggable]="false" [resizable]="false">
        <div id="home-rename-dialog-content">
            <label for="home-rename-dialog-name-input">New Name</label>
            <input pInputText id="home-rename-dialog-name-input" type="text" [ngModel]="renameProfileName()"
                (ngModelChange)="renameProfileName.set($event)" class="w-full" />
        </div>
        <ng-template #footer>
            <p-button id="home-rename-dialog-cancel-btn" label="Cancel" severity="secondary"
                (click)="showRenameDialog.set(false)" />
            <p-button id="home-rename-dialog-submit-btn" label="Rename" (click)="renameProfile()" />
        </ng-template>
    </p-dialog>

    <!-- Edit Profile Dialog -->
    <app-profile-edit-dialog [visible]="showEditDialog()" [profile]="selectedProfile()" [allProfiles]="profiles()"
        [availableBrowsers]="availableBrowsers()" [folders]="allFolders()" [proxyGroups]="proxyGroups()"
        [savedProxies]="proxyService.proxies()" (visibleChange)="showEditDialog.set($event)"
        (save)="onEditDialogSave($event)" #editDialog />

    <!-- Duplicate Profile Dialog -->
    <p-dialog id="home-duplicate-dialog" header="Duplicate Profile" [(visible)]="showDuplicateDialog" [modal]="true"
        [style]="{ width: 'min(400px, 95vw)' }" [draggable]="false" [resizable]="false">
        <div id="home-duplicate-dialog-content" class="py-2">
            <p class="text-sm text-muted-color mb-4">Create a copy of "{{ selectedProfile()?.name
                }}"</p>
            <label for="home-duplicate-dialog-name-input" class="block text-xs font-medium text-color mb-2">New
                Name</label>
            <input pInputText id="home-duplicate-dialog-name-input" type="text" [ngModel]="duplicateProfileName()"
                (ngModelChange)="duplicateProfileName.set($event)" class="w-full" />
        </div>
        <ng-template #footer>
            <div id="home-duplicate-dialog-footer" class="flex justify-end gap-3 pt-2">
                <p-button id="home-duplicate-dialog-cancel-btn" label="Cancel" severity="secondary"
                    (click)="showDuplicateDialog.set(false)" />
                <p-button id="home-duplicate-dialog-submit-btn" label="Duplicate" (click)="duplicateProfile()" />
            </div>
        </ng-template>
    </p-dialog>

    <!-- Phase 3: Activity Log Dialog -->
    <p-dialog id="home-activity-log-dialog" header="Activity Log" [(visible)]="showActivityLog" [modal]="true"
        [style]="{ width: 'min(500px, 95vw)', maxHeight: '70vh' }" [draggable]="false" [resizable]="false">
        <div id="home-activity-log-content" class="py-2">
            @if (activityLog.entries().length === 0) {
            <div class="flex flex-col items-center justify-center py-8 text-center">
                <i class="pi pi-history text-3xl text-muted-color mb-3"></i>
                <p class="text-muted-color">No activity recorded yet</p>
                <p class="text-xs text-muted-color mt-1">Launch, create, or delete profiles to see activity here</p>
            </div>
            } @else {
            <div class="space-y-2 max-h-[400px] overflow-y-auto">
                @for (entry of activityLog.entries(); track entry.id; let i = $index) {
                <div [id]="'home-activity-entry-' + i"
                    class="flex items-start gap-3 p-3 rounded-lg border border-surface hover:bg-surface-50 dark:hover:bg-surface-800 transition-colors">
                    <!-- Icon -->
                    <div class="w-8 h-8 rounded-lg flex items-center justify-center shrink-0" [class]="{
                        'bg-green-500/20 text-green-500': entry.type === 'launch',
                        'bg-blue-500/20 text-blue-500': entry.type === 'create',
                        'bg-red-500/20 text-red-500': entry.type === 'delete',
                        'bg-purple-500/20 text-purple-500': entry.type === 'duplicate',
                        'bg-yellow-500/20 text-yellow-500': entry.type === 'edit'
                    }">
                        <i [class]="'pi ' + activityLog.getTypeIcon(entry.type)"></i>
                    </div>
                    <!-- Content -->
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center gap-2">
                            <span class="font-medium text-color truncate">{{ entry.profileName }}</span>
                            <span
                                class="text-xs px-1.5 py-0.5 rounded bg-surface-100 dark:bg-surface-700 text-muted-color">{{
                                activityLog.getTypeLabel(entry.type) }}</span>
                        </div>
                        <div class="flex items-center gap-2 mt-1 text-xs text-muted-color">
                            <span>{{ activityLog.formatTimestamp(entry.timestamp) }}</span>
                            @if (entry.browser) {
                            <span>• {{ entry.browser | titlecase }}</span>
                            }
                            @if (entry.details) {
                            <span>• {{ entry.details }}</span>
                            }
                        </div>
                    </div>
                </div>
                }
            </div>
            }
        </div>
        <ng-template #footer>
            <div id="home-activity-log-footer" class="flex justify-between items-center pt-2">
                <p-button id="home-activity-log-clear-btn" label="Clear Log" severity="danger" [outlined]="true"
                    icon="pi pi-trash" (click)="activityLog.clearLog()"
                    [disabled]="activityLog.entries().length === 0" />
                <p-button id="home-activity-log-close-btn" label="Close" severity="secondary"
                    (click)="showActivityLog.set(false)" />
            </div>
        </ng-template>
    </p-dialog>

    <!-- Create Folder Dialog -->
    <p-dialog [(visible)]="showCreateFolderDialog" header="Create Folder" [modal]="true" [style]="{ width: '400px' }"
        [draggable]="false" [resizable]="false">
        <div class="flex flex-col gap-4">
            <div class="flex flex-col gap-2">
                <label for="folderName" class="font-medium">Folder Name</label>
                <input pInputText id="folderName" [(ngModel)]="newFolderName" (keydown.enter)="createFolder()"
                    autofocus />
            </div>
            <!-- Icon Selector -->
            <div class="flex flex-col gap-2">
                <label class="font-medium">Icon</label>
                <div class="flex flex-wrap gap-2">
                    @for (icon of folderIcons; track icon) {
                    <button type="button"
                        class="w-8 h-8 rounded-md border flex items-center justify-center transition-all cursor-pointer"
                        [class]="newFolderIcon() === icon
                            ? 'border-primary bg-primary/10 text-primary ring-2 ring-primary/30'
                            : 'border-surface-200 dark:border-surface-700 text-muted-color hover:border-primary/50'"
                        (click)="newFolderIcon.set(icon)" [pTooltip]="icon">
                        <i [class]="'pi ' + icon + ' text-sm'"></i>
                    </button>
                    }
                </div>
            </div>
            <!-- Color Selector -->
            <div class="flex flex-col gap-2">
                <label class="font-medium">Color</label>
                <div class="flex flex-wrap gap-2">
                    @for (color of folderColors; track color) {
                    <button type="button" class="w-7 h-7 rounded-full border-2 transition-all cursor-pointer" [class]="newFolderColor() === color
                            ? 'ring-2 ring-offset-2 ring-offset-surface-0 dark:ring-offset-surface-900 scale-110'
                            : 'hover:scale-110'" [style.background-color]="color"
                        [style.border-color]="newFolderColor() === color ? color : 'transparent'"
                        (click)="newFolderColor.set(color)">
                    </button>
                    }
                    <!-- No color option -->
                    <button type="button"
                        class="w-7 h-7 rounded-full border-2 border-surface-300 dark:border-surface-600 transition-all cursor-pointer flex items-center justify-center"
                        [class]="!newFolderColor() ? 'ring-2 ring-offset-2 ring-primary' : 'hover:scale-110'"
                        (click)="newFolderColor.set('')" pTooltip="No color">
                        <i class="pi pi-ban text-xs text-muted-color"></i>
                    </button>
                </div>
            </div>
        </div>
        <ng-template pTemplate="footer">
            <p-button label="Cancel" (click)="showCreateFolderDialog.set(false)" [text]="true" severity="secondary" />
            <p-button label="Create" (click)="createFolder()" [disabled]="!newFolderName().trim()" />
        </ng-template>
    </p-dialog>

    <!-- Manage Folders Dialog -->
    <p-dialog [(visible)]="showManageFoldersDialog" header="Manage Folders" [modal]="true" [style]="{ width: '500px' }"
        [draggable]="false" [resizable]="false">
        <div class="flex flex-col gap-2">
            <div class="text-muted-color text-sm mb-2">Custom folders only. System folders cannot be changed.</div>

            @if (allFolders().length === 0) {
            <div class="text-center p-4 text-muted-color">No custom folders.</div>
            }

            <div class="flex flex-col gap-2 max-h-[60vh] overflow-y-auto">
                @for (folder of allFolders(); track folder.id) {
                @if (!folderService.isSystemFolder(folder.id)) {
                <div
                    class="flex items-center justify-between p-3 border border-surface-200 dark:border-surface-700 rounded-lg bg-surface-50 dark:bg-surface-900">
                    @if (editingFolderId() === folder.id) {
                    <div class="flex items-center gap-2 flex-1 mr-2">
                        <input pInputText [(ngModel)]="editFolderName" class="w-full p-inputtext-sm"
                            (keydown.enter)="saveEditFolder()" />
                    </div>
                    <!-- Inline icon/color editor -->
                    <div class="flex items-center gap-2 flex-1 mr-2 mt-2">
                        <div class="flex flex-wrap gap-1">
                            @for (icon of folderIcons; track icon) {
                            <button type="button"
                                class="w-6 h-6 rounded flex items-center justify-center transition-all cursor-pointer text-xs"
                                [class]="editFolderIcon() === icon
                                    ? 'bg-primary/10 text-primary ring-1 ring-primary/50'
                                    : 'text-muted-color hover:text-color'" (click)="editFolderIcon.set(icon)">
                                <i [class]="'pi ' + icon"></i>
                            </button>
                            }
                        </div>
                        <div class="border-l border-surface-200 dark:border-surface-700 h-5 mx-1"></div>
                        <div class="flex flex-wrap gap-1">
                            @for (color of folderColors; track color) {
                            <button type="button" class="w-5 h-5 rounded-full transition-all cursor-pointer"
                                [class]="editFolderColor() === color ? 'ring-2 ring-offset-1 scale-110' : 'hover:scale-110'"
                                [style.background-color]="color" (click)="editFolderColor.set(color)">
                            </button>
                            }
                            <button type="button"
                                class="w-5 h-5 rounded-full border border-surface-300 dark:border-surface-600 flex items-center justify-center cursor-pointer"
                                [class]="!editFolderColor() ? 'ring-2 ring-offset-1 ring-primary' : ''"
                                (click)="editFolderColor.set('')">
                                <i class="pi pi-ban text-[8px] text-muted-color"></i>
                            </button>
                        </div>
                    </div>
                    <div class="flex items-center gap-1">
                        <p-button icon="pi pi-check" [text]="true" [rounded]="true" severity="success"
                            (click)="saveEditFolder()" />
                        <p-button icon="pi pi-times" [text]="true" [rounded]="true" severity="secondary"
                            (click)="cancelEditFolder()" />
                    </div>
                    } @else {
                    <div class="flex items-center gap-3 flex-1 overflow-hidden">
                        <i [class]="'pi ' + (folder.icon || 'pi-folder')" [style.color]="folder.color"></i>
                        <span class="font-medium truncate">{{ folder.name }}</span>
                        <span class="text-xs text-muted-color">({{ folder.profileCount || 0 }})</span>
                    </div>
                    <div class="flex items-center gap-1">
                        <p-button icon="pi pi-pencil" [text]="true" [rounded]="true" severity="secondary"
                            (click)="startEditFolder(folder)" />
                        <p-button icon="pi pi-trash" [text]="true" [rounded]="true" severity="danger"
                            (click)="deleteFolder(folder.id)" />
                    </div>
                    }
                </div>
                }
                }
            </div>
        </div>
        <ng-template pTemplate="footer">
            <p-button label="Close" (click)="showManageFoldersDialog.set(false)" [text]="true" />
            <p-button icon="pi pi-plus" label="New Folder" (click)="onAddFolder()" [text]="true" severity="info" />
        </ng-template>
    </p-dialog>

    <!-- Feature 12.1: Mass Tag Assign Dialog -->
    <p-dialog id="home-mass-tag-dialog" header="Assign Tags to Selected Profiles" [(visible)]="showMassTagDialog"
        [modal]="true" [style]="{ width: 'min(480px, 95vw)' }" [draggable]="false" [resizable]="false">
        <div id="home-mass-tag-content" class="py-2">
            <p class="text-sm text-muted-color mb-4">
                Select tags to apply to {{ selectedProfiles().length }} selected profile(s).
                Tags will be merged with existing tags.
            </p>

            <!-- Existing Tags -->
            @if (availableTags().length > 0) {
            <div class="mb-4">
                <label class="block text-xs font-medium text-color mb-2">Existing Tags</label>
                <div class="flex flex-wrap gap-2">
                    @for (tag of availableTags(); track tag) {
                    <button [id]="'home-mass-tag-chip-' + tag" (click)="toggleMassTag(tag)"
                        [class]="massTagSelection().includes(tag) 
                            ? 'px-3 py-1.5 rounded-lg text-sm font-medium bg-primary text-white border border-primary transition-all duration-200 shadow-sm'
                            : 'px-3 py-1.5 rounded-lg text-sm font-medium bg-surface-100 dark:bg-surface-800 text-color border border-surface-200 dark:border-surface-700 hover:border-primary/50 transition-all duration-200'">
                        <i class="pi pi-tag text-xs mr-1.5"></i>{{ tag }}
                    </button>
                    }
                </div>
            </div>
            }

            <!-- Selected Tags Preview -->
            @if (massTagSelection().length > 0) {
            <div class="mb-4 p-3 bg-primary/10 border border-primary/30 rounded-lg">
                <div class="flex items-center gap-2 flex-wrap">
                    <span class="text-xs font-medium text-primary">Will apply:</span>
                    @for (tag of massTagSelection(); track tag) {
                    <span
                        class="inline-flex items-center gap-1 px-2 py-0.5 bg-primary/20 text-primary text-xs rounded-full">
                        {{ tag }}
                        <button (click)="toggleMassTag(tag)" class="hover:text-red-500 transition-colors">
                            <i class="pi pi-times text-[10px]"></i>
                        </button>
                    </span>
                    }
                </div>
            </div>
            }

            <!-- Create New Tag -->
            <div>
                <label for="home-mass-tag-new-input" class="block text-xs font-medium text-color mb-2">Create New
                    Tag</label>
                <div class="flex gap-2">
                    <input pInputText id="home-mass-tag-new-input" type="text" [ngModel]="newMassTag()"
                        (ngModelChange)="newMassTag.set($event)" (keydown.enter)="addNewMassTag()"
                        placeholder="Type and press Enter" class="flex-1" />
                    <p-button icon="pi pi-plus" (click)="addNewMassTag()" [disabled]="!newMassTag().trim()" />
                </div>
            </div>
        </div>
        <ng-template #footer>
            <p-button id="home-mass-tag-cancel-btn" label="Cancel" severity="secondary"
                (click)="showMassTagDialog.set(false)" />
            <p-button id="home-mass-tag-apply-btn" label="Apply Tags" icon="pi pi-check" (click)="bulkAssignTags()"
                [disabled]="massTagSelection().length === 0" />
        </ng-template>
    </p-dialog>
</div>