<!-- Sidebar -->
<app-home-sidebar [folders]="folders()" [selectedFolderId]="selectedFolderId()"
    (folderSelected)="onFolderSelected($event)" (addFolderClicked)="onAddFolder()" (settingsClicked)="onSettings()" />

<!-- Main Content -->
<div id="home-container" class="flex-1 flex flex-col min-h-0 text-color overflow-hidden">
    <!-- Header Toolbar -->
    <header id="home-header"
        class="flex items-center gap-4 px-6 h-[var(--spacing-header)] shrink-0 border-b border-surface">
        <!-- Search (full width) -->
        <div id="home-header-search" class="flex-1">
            <p-iconfield class="w-full">
                <p-inputicon class="pi pi-search" />
                <input id="home-header-search-input" pInputText type="text" placeholder="Search profiles..."
                    class="w-full" [ngModel]="searchText()" (ngModelChange)="onSearchInput($event)" />
            </p-iconfield>
        </div>

        <!-- Actions -->
        <div id="home-header-actions" class="flex items-center gap-2">
            <p-button id="home-header-refresh-btn" (click)="scanProfiles()" icon="pi pi-refresh" label="Refresh"
                severity="secondary" [outlined]="true" />

            <!-- Sort Menu -->
            <p-menu #sortMenu [model]="sortMenuItems()" [popup]="true" />
            <p-button id="home-header-sort-btn" (click)="sortMenu.toggle($event)" icon="pi pi-sort-alt"
                [label]="currentSortLabel()" severity="secondary" [outlined]="true" />

            <!-- Filters Menu -->
            <p-menu #filterMenu [model]="filterMenuItems()" [popup]="true" />
            <p-button id="home-header-filters-btn" (click)="filterMenu.toggle($event)" icon="pi pi-filter"
                label="Filters" severity="secondary" [outlined]="true"
                [badge]="activeFilterCount() > 0 ? activeFilterCount().toString() : undefined" />

            <!-- View Mode Toggle -->
            <p-buttonGroup>
                <p-button icon="pi pi-list" (onClick)="viewMode.set('table')" [outlined]="viewMode() !== 'table'"
                    severity="secondary" />
                <p-button icon="pi pi-th-large" (onClick)="viewMode.set('grid')" [outlined]="viewMode() !== 'grid'"
                    severity="secondary" />
            </p-buttonGroup>

            <!-- Phase 2: Show Hidden Toggle -->
            <p-button id="home-header-hidden-toggle" (click)="showHidden.set(!showHidden())"
                [icon]="showHidden() ? 'pi pi-eye' : 'pi pi-eye-slash'"
                [label]="showHidden() ? 'Hide Hidden' : 'Show Hidden'" severity="secondary" [outlined]="true"
                [class]="showHidden() ? 'ring-1 ring-primary' : ''" />

            <!-- Feature 2.4: Favorites Filter -->
            <p-button id="home-header-favorites-toggle" (click)="filterFavoritesOnly.set(!filterFavoritesOnly())"
                icon="pi pi-heart"
                [label]="filterFavoritesOnly() ? 'All Profiles' : 'Favorites (' + favoriteCount() + ')'"
                severity="secondary" [outlined]="true" [class]="filterFavoritesOnly() ? 'ring-1 ring-primary' : ''" />

            <!-- Phase 3: Activity Log -->
            <p-button id="home-header-activity-log-btn" (click)="showActivityLog.set(true)" icon="pi pi-history"
                severity="secondary" [outlined]="true" pTooltip="Activity Log"
                [badge]="activityLog.todayEntries().length > 0 ? activityLog.todayEntries().length.toString() : undefined" />

            <p-button id="home-header-create-btn" (click)="openCreateDialog()" icon="pi pi-plus"
                label="Create profile" />
        </div>
    </header>

    <!-- Tabs -->
    <div id="home-tabs" class="flex items-center justify-between px-6 py-3 border-b border-surface shrink-0">
        <nav id="home-tabs-nav" class="flex items-center gap-6">
            @for (tab of tabs; track tab.key; let i = $index) {
            <button [id]="'home-tab-' + i"
                class="flex items-center gap-2 pb-2 text-sm font-medium transition-colors border-b-2 -mb-[13px]"
                [class]="activeTab() === tab.key
            ? 'text-color border-primary'
            : 'text-muted-color border-transparent hover:text-muted-color'" (click)="setActiveTab(tab.key)">
                <i [class]="'pi ' + tab.icon + ' text-sm'"></i>
                <span>{{ tab.label }}</span>
            </button>
            }
        </nav>
        <span id="home-tabs-usage" class="text-sm text-muted-color">{{ profilesUsed() }} of {{
            maxProfiles() }} profiles
            used</span>
    </div>

    <!-- Content -->
    <div id="home-content" class="flex-1 min-h-0 overflow-auto p-6 pb-4">
        @if (loading()) {
        <div id="home-loading" class="flex flex-col items-center justify-center py-16 gap-4 text-muted-color">
            <p-progressSpinner strokeWidth="3" />
            <p>Scanning profiles...</p>
        </div>
        } @else if (profiles().length === 0) {
        <div id="home-empty" class="flex flex-col items-center justify-center py-16 text-center">
            <div id="home-empty-icon"
                class="w-20 h-20 rounded-2xl border border-surface flex items-center justify-center mb-5">
                <i class="pi pi-inbox text-3xl text-zinc-400"></i>
            </div>
            <h3 id="home-empty-title" class="text-lg font-semibold text-color mb-2">No
                Profiles Found</h3>
            <p id="home-empty-desc" class="text-sm text-muted-color">Enter the path to your Chrome
                profiles folder and
                click Scan</p>
        </div>
        } @else if (filteredProfiles().length === 0 && hasActiveFilters()) {
        <!-- No search results -->
        <div id="home-no-results" class="flex flex-col items-center justify-center py-16 text-center">
            <div class="w-20 h-20 rounded-2xl border border-surface flex items-center justify-center mb-5">
                <i class="pi pi-search text-3xl text-zinc-400"></i>
            </div>
            <h3 class="text-lg font-semibold text-color mb-2">No Matching Profiles</h3>
            <p class="text-sm text-muted-color mb-4">Try adjusting your search or filters</p>
            <button (click)="clearFilters()"
                class="px-4 py-2 bg-primary text-white text-sm font-medium rounded-lg hover:bg-primary-hover transition-colors">
                Clear filters
            </button>
        </div>
        } @else if (activeTab() === 'profiles') {
        <!-- Profiles View - Table or Grid -->
        @if (viewMode() === 'table') {
        <!-- Profiles Table -->
        <p-table id="home-profiles-table" [value]="filteredProfiles()" [(selection)]="selectedProfiles"
            (selectionChange)="onSelectionChange($event)" [first]="first()" [rows]="rowsPerPage()" dataKey="path"
            [scrollable]="true">

            <!-- Header -->
            <ng-template pTemplate="header">
                <tr id="home-profiles-table-header">
                    <th style="width: 3rem"><p-tableHeaderCheckbox /></th>
                    <th style="width: 3rem"><i class="pi pi-star"></i></th>
                    <th>Name</th>
                    <th>Status</th>
                    <th>Proxy</th>
                    <th>Tags</th>
                    <th>Notes</th>
                    <th style="width: 3rem"><i class="pi pi-cog"></i></th>
                </tr>
            </ng-template>

            <!-- Body -->
            <ng-template pTemplate="body" let-profile let-i="rowIndex">
                <tr [id]="'home-profile-row-' + i" (click)="openEditDialog(profile, $event)" style="cursor: pointer">
                    <!-- Checkbox -->
                    <td (click)="$event.stopPropagation()">
                        <p-tableCheckbox [value]="profile" />
                    </td>

                    <!-- Pin -->
                    <td>
                        <button [id]="'home-profile-' + i + '-pin-btn'" (click)="togglePin(profile, $event)"
                            class="w-7 h-7 rounded-md transition-colors flex items-center justify-center" [class]="profile.metadata?.isPinned 
                                     ? 'text-yellow-400 hover:text-yellow-300' 
                                     : 'text-muted-color hover:text-zinc-400'">
                            <i [class]="profile.metadata?.isPinned ? 'pi pi-star-fill' : 'pi pi-star'"></i>
                        </button>
                    </td>

                    <!-- Name with Start button -->
                    <td>
                        <div class="flex items-center gap-3">
                            <!-- Phase 1: Color dot -->
                            @if (profile.metadata?.color) {
                            <span class="w-3 h-3 rounded-full flex-shrink-0"
                                [style.background-color]="profile.metadata.color"></span>
                            }
                            <p-button [id]="'home-profile-' + i + '-start-btn'" (click)="launchProfile(profile, $event)"
                                [icon]="'pi ' + getOsIcon(profile)" label="Start" size="small" [outlined]="true" />
                            <span [class]="profile.metadata?.isHidden ? 'opacity-50' : ''"
                                [pTooltip]="getProfileTooltip(profile)" tooltipPosition="right" [escape]="false">{{
                                profile.name }}</span>
                            <!-- Phase 2: Hidden indicator -->
                            @if (profile.metadata?.isHidden) {
                            <i class="pi pi-eye-slash text-xs text-muted-color" pTooltip="Hidden profile"></i>
                            }
                        </div>
                    </td>

                    <!-- Status -->
                    <td>
                        <span class="px-2.5 py-1 border border-surface rounded text-xs text-muted-color">
                            No status
                        </span>
                    </td>

                    <!-- Proxy -->
                    <td>
                        <p-button [id]="'home-profile-' + i + '-proxy-btn'" icon="pi pi-plus" [rounded]="true"
                            [text]="true" severity="secondary" size="small" />
                    </td>

                    <!-- Tags -->
                    <td>
                        @if (profile.metadata?.tags && profile.metadata.tags.length > 0) {
                        <div class="flex flex-wrap gap-1">
                            @for (tag of profile.metadata.tags.slice(0, 3); track tag) {
                            <span
                                class="px-2 py-0.5 bg-primary/20 border border-primary/40 rounded text-xs text-primary">
                                {{ tag }}
                            </span>
                            }
                            @if (profile.metadata.tags.length > 3) {
                            <span class="px-2 py-0.5 border border-surface rounded text-xs text-color">
                                +{{ profile.metadata.tags.length - 3 }}
                            </span>
                            }
                        </div>
                        } @else {
                        <p-button [id]="'home-profile-' + i + '-tags-btn'" icon="pi pi-plus" [rounded]="true"
                            [text]="true" severity="secondary" size="small" />
                        }
                    </td>

                    <!-- Notes -->
                    <td>
                        @if (profile.metadata?.notes) {
                        <span
                            class="inline-flex items-center gap-1.5 px-2.5 py-1 bg-note-yellow/20 border border-note-yellow/40 rounded text-xs text-note-yellow">
                            <i class="pi pi-pencil text-[10px]"></i>
                            <span class="max-w-[100px] truncate">{{ profile.metadata?.notes }}</span>
                        </span>
                        } @else {
                        <p-button [id]="'home-profile-' + i + '-notes-btn'" icon="pi pi-plus" [rounded]="true"
                            [text]="true" severity="secondary" size="small" />
                        }
                    </td>

                    <!-- Actions -->
                    <td>
                        <div class="flex items-center gap-1">
                            <p-button [id]="'home-profile-' + i + '-incognito-btn'"
                                (click)="launchProfileIncognito(profile, $event)" icon="pi pi-eye-slash"
                                [rounded]="true" [text]="true" severity="secondary" size="small"
                                pTooltip="Launch in Incognito" />
                            <p-button [id]="'home-profile-' + i + '-duplicate-btn'"
                                (click)="openDuplicateDialog(profile, $event)" icon="pi pi-copy" [rounded]="true"
                                [text]="true" severity="secondary" size="small" pTooltip="Duplicate profile" />
                            <p-button [id]="'home-profile-' + i + '-backup-btn'"
                                (click)="backupProfile(profile, $event)" icon="pi pi-download" [rounded]="true"
                                [text]="true" severity="secondary" size="small" pTooltip="Backup to ZIP" />
                            <!-- Phase 2: Hide toggle -->
                            <p-button [id]="'home-profile-' + i + '-hide-btn'" (click)="toggleHide(profile, $event)"
                                [icon]="profile.metadata?.isHidden ? 'pi pi-eye' : 'pi pi-eye-slash'" [rounded]="true"
                                [text]="true" severity="secondary" size="small"
                                [pTooltip]="profile.metadata?.isHidden ? 'Show profile' : 'Hide profile'" />
                            <!-- Feature 2.4: Favorites toggle -->
                            <p-button [id]="'home-profile-' + i + '-favorite-btn'"
                                (click)="toggleFavorite(profile, $event)"
                                [icon]="profile.metadata?.isFavorite ? 'pi pi-heart-fill' : 'pi pi-heart'"
                                [rounded]="true" [text]="true"
                                [severity]="profile.metadata?.isFavorite ? 'danger' : 'secondary'" size="small"
                                [pTooltip]="profile.metadata?.isFavorite ? 'Remove from Favorites' : 'Add to Favorites'" />
                            <p-button [id]="'home-profile-' + i + '-delete-btn'"
                                (click)="deleteProfile(profile, $event)" icon="pi pi-trash" [rounded]="true"
                                [text]="true" severity="danger" size="small" pTooltip="Delete profile" />
                        </div>
                    </td>
                </tr>
            </ng-template>

            <!-- Empty state -->
            <ng-template pTemplate="emptymessage">
                <tr>
                    <td colspan="8">No profiles in this folder</td>
                </tr>
            </ng-template>
        </p-table>

        <!-- Paginator inside table container -->
        @if (filteredProfiles().length > 0) {
        <p-paginator [rows]="rowsPerPage()" [totalRecords]="filteredProfiles().length" [first]="first()"
            [rowsPerPageOptions]="[5, 10, 20]" (onPageChange)="onPaginatorChange($event)" [showCurrentPageReport]="true"
            currentPageReportTemplate="Showing {first} to {last} of {totalRecords} profiles" />
        }
        } @else {
        <!-- Grid View -->
        <div id="home-profiles-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4"
            cdkDropList [cdkDropListDisabled]="sortBy() !== 'custom'" (cdkDropListDropped)="onProfileDrop($event)">
            @for (profile of filteredProfiles(); track profile.path; let i = $index) {
            <div [id]="'home-profile-card-' + i"
                class="border border-surface rounded-xl p-4 hover:border-primary/50 transition-all duration-300 cursor-pointer relative group shadow-sm hover:shadow-md"
                [class.hover:-translate-y-1]="sortBy() !== 'custom'" [class.cursor-grab]="sortBy() === 'custom'" cdkDrag
                [cdkDragDisabled]="sortBy() !== 'custom'" (click)="openEditDialog(profile, $event)"
                [pTooltip]="getProfileTooltip(profile)" tooltipPosition="top" [escape]="false">
                <!-- Drag Handle indicator (only in custom sort mode) -->
                @if (sortBy() === 'custom') {
                <div
                    class="absolute top-2 right-2 text-muted-color opacity-0 group-hover:opacity-100 transition-opacity">
                    <i class="pi pi-arrows-alt text-xs"></i>
                </div>
                }
                <!-- Phase 1: Color indicator -->
                @if (profile.metadata?.color) {
                <div class="absolute top-2 left-2">
                    <span class="w-3 h-3 rounded-full inline-block"
                        [style.background-color]="profile.metadata?.color"></span>
                </div>
                }
                <!-- Pin indicator -->
                @if (profile.metadata?.isPinned && sortBy() !== 'custom') {
                <div class="absolute top-2 right-2">
                    <i class="pi pi-star-fill text-yellow-400 text-xs"></i>
                </div>
                }
                <!-- Phase 2: Hidden indicator -->
                @if (profile.metadata?.isHidden) {
                <div class="absolute top-2" [class]="profile.metadata?.color ? 'left-7' : 'left-2'">
                    <i class="pi pi-eye-slash text-muted-color text-xs"></i>
                </div>
                }
                <!-- Avatar/Emoji -->
                <div class="w-14 h-14 rounded-xl flex items-center justify-center mb-3 text-2xl"
                    [class]="profile.metadata?.isHidden ? 'opacity-50' : ''">
                    {{ getProfileDisplay(profile) }}
                </div>
                <!-- Name -->
                <h3 class="text-sm font-semibold text-color mb-1 truncate"
                    [class]="profile.metadata?.isHidden ? 'opacity-50' : ''">
                    {{ profile.name }}
                </h3>
                <!-- Tags -->
                @if (profile.metadata?.tags?.length) {
                <div class="flex flex-wrap gap-1 mb-2">
                    @for (tag of profile.metadata!.tags!.slice(0, 2); track tag) {
                    <span class="px-2 py-0.5 bg-primary/20 text-primary text-xs rounded">{{ tag }}</span>
                    }
                </div>
                }
                <!-- Actions -->
                <div class="flex items-center gap-2 mt-3 opacity-0 group-hover:opacity-100 transition-opacity">
                    <p-button (click)="launchProfile(profile, $event)" label="Start" size="small" class="flex-1" />
                    <button (click)="openDuplicateDialog(profile, $event)"
                        class="p-1.5 text-muted-color hover:text-primary transition-colors" title="Duplicate">
                        <i class="pi pi-copy text-sm"></i>
                    </button>
                    <button (click)="backupProfile(profile, $event)"
                        class="p-1.5 text-muted-color hover:text-primary transition-colors" title="Backup to ZIP">
                        <i class="pi pi-download text-sm"></i>
                    </button>
                    <!-- Feature 2.4: Favorites toggle -->
                    <button (click)="toggleFavorite(profile, $event)" [class]="profile.metadata?.isFavorite 
                            ? 'p-1.5 text-red-500 hover:text-red-400 transition-colors' 
                            : 'p-1.5 text-muted-color hover:text-red-500 transition-colors'"
                        [title]="profile.metadata?.isFavorite ? 'Remove from Favorites' : 'Add to Favorites'">
                        <i
                            [class]="profile.metadata?.isFavorite ? 'pi pi-heart-fill text-sm' : 'pi pi-heart text-sm'"></i>
                    </button>
                    <button (click)="deleteProfile(profile, $event)"
                        class="p-1.5 text-muted-color hover:text-error transition-colors" title="Delete">
                        <i class="pi pi-trash text-sm"></i>
                    </button>
                </div>

                <!-- CDK Drag Placeholder -->
                <div *cdkDragPlaceholder
                    class="border-2 border-dashed border-primary/50 rounded-xl bg-primary/5 h-full"></div>
            </div>
            }
        </div>
        }
        } @else {
        <!-- Other tabs placeholder -->
        <div id="home-tab-placeholder" class="flex flex-col items-center justify-center py-16 text-center">
            <div id="home-tab-placeholder-icon"
                class="w-16 h-16 rounded-xl border border-surface flex items-center justify-center mb-4">
                <i class="pi pi-cog text-2xl text-zinc-400"></i>
            </div>
            <h3 id="home-tab-placeholder-title" class="text-lg font-semibold text-color mb-2">
                {{ activeTab() |
                titlecase }}</h3>
            <p id="home-tab-placeholder-desc" class="text-sm text-muted-color">Coming soon...</p>
        </div>
        }
    </div>

    <!-- Bottom Actions Bar (Fixed at bottom, like sidebar-bottom) -->
    @if (selectedProfiles().length > 0 && activeTab() === 'profiles') {
    <div id="home-bottom" class="shrink-0 border-t border-surface p-3">
        <div id="home-bottom-actions" class="flex items-center gap-3">
            <button id="home-bottom-clear-btn" (click)="clearSelection()"
                class="w-8 h-8 rounded-md border border-surface text-muted-color hover:text-color transition-colors flex items-center justify-center"
                title="Clear selection">
                <i class="pi pi-times"></i>
            </button>
            <div class="w-px h-6 bg-border"></div>
            <button id="home-bottom-start-all-btn" (click)="bulkLaunch()"
                class="h-8 flex items-center gap-2 px-3 rounded-md border border-primary text-primary hover:bg-primary hover:text-white transition-colors"
                title="Launch all selected">
                <i class="pi pi-play text-sm"></i>
                <span class="text-sm font-medium">Launch All</span>
            </button>
            <button id="home-bottom-delete-btn" (click)="bulkDelete()"
                class="h-8 flex items-center gap-2 px-3 rounded-md border border-error text-error hover:bg-error hover:text-white transition-colors"
                title="Delete selected">
                <i class="pi pi-trash text-sm"></i>
                <span class="text-sm font-medium">Delete</span>
            </button>
            <div class="flex-1"></div>
            <span id="home-bottom-selected-count" class="text-sm font-medium text-primary">
                {{ selectedProfiles().length }} profiles selected
            </span>
        </div>
    </div>
    }

    <!-- Create Profile Dialog -->
    <p-dialog id="home-create-dialog" header="Create New Profile" [(visible)]="showCreateDialog" [modal]="true"
        [style]="{ width: '400px' }" [draggable]="false" [resizable]="false">
        <div id="home-create-dialog-content">
            <label for="home-create-dialog-name-input">Profile Name</label>
            <input pInputText id="home-create-dialog-name-input" type="text" [ngModel]="newProfileName()"
                (ngModelChange)="newProfileName.set($event)" placeholder="e.g., Work, Personal" class="w-full" />
        </div>
        <ng-template #footer>
            <p-button id="home-create-dialog-cancel-btn" label="Cancel" severity="secondary"
                (click)="showCreateDialog.set(false)" />
            <p-button id="home-create-dialog-submit-btn" label="Create" (click)="createProfile()" />
        </ng-template>
    </p-dialog>

    <!-- Rename Profile Dialog -->
    <p-dialog id="home-rename-dialog" header="Rename Profile" [(visible)]="showRenameDialog" [modal]="true"
        [style]="{ width: '400px' }" [draggable]="false" [resizable]="false">
        <div id="home-rename-dialog-content">
            <label for="home-rename-dialog-name-input">New Name</label>
            <input pInputText id="home-rename-dialog-name-input" type="text" [ngModel]="renameProfileName()"
                (ngModelChange)="renameProfileName.set($event)" class="w-full" />
        </div>
        <ng-template #footer>
            <p-button id="home-rename-dialog-cancel-btn" label="Cancel" severity="secondary"
                (click)="showRenameDialog.set(false)" />
            <p-button id="home-rename-dialog-submit-btn" label="Rename" (click)="renameProfile()" />
        </ng-template>
    </p-dialog>

    <!-- Edit Profile Dialog -->
    <p-dialog id="home-edit-dialog" header="Edit Profile" [(visible)]="showEditDialog" [modal]="true"
        [style]="{ width: '500px' }" [draggable]="false" [resizable]="false">
        <div id="home-edit-dialog-content" class="py-2 space-y-5">
            <!-- Icon -->
            <div id="home-edit-dialog-icon-section">
                <label class="block text-xs font-medium text-color mb-2">Icon</label>
                <div id="home-edit-dialog-icon-options" class="flex flex-wrap gap-2">
                    @for (emoji of emojiOptions; track emoji; let i = $index) {
                    <button [id]="'home-edit-dialog-emoji-' + i"
                        class="w-10 h-10 rounded-lg border flex items-center justify-center text-xl cursor-pointer transition-all duration-150"
                        [class]="editEmoji() === emoji ? 'bg-primary border-primary text-white' : 'border-surface hover:border-primary'"
                        (click)="selectEmoji(emoji)">
                        {{ emoji }}
                    </button>
                    }
                </div>
            </div>

            <!-- Group -->
            <div id="home-edit-dialog-group-section">
                <label class="block text-xs font-medium text-color mb-2">Group</label>
                <div id="home-edit-dialog-group-options" class="flex flex-wrap gap-2">
                    @for (group of groupOptions; track group; let i = $index) {
                    <button [id]="'home-edit-dialog-group-' + i"
                        class="px-3 py-2 rounded-lg border text-sm cursor-pointer transition-all duration-150"
                        [class]="editGroup() === group ? 'bg-primary border-primary text-white' : 'border-surface text-muted-color hover:border-primary'"
                        (click)="selectGroup(group)">
                        {{ group }}
                    </button>
                    }
                </div>
            </div>

            <!-- Shortcut -->
            <div id="home-edit-dialog-shortcut-section">
                <label class="block text-xs font-medium text-color mb-2">Keyboard
                    Shortcut</label>
                <div id="home-edit-dialog-shortcut-options" class="flex flex-wrap gap-2">
                    @for (num of shortcutOptions; track num; let i = $index) {
                    <button [id]="'home-edit-dialog-shortcut-' + i"
                        class="w-10 h-10 rounded-lg border flex items-center justify-center text-sm font-mono cursor-pointer transition-all duration-150"
                        [class]="editShortcut() === num ? 'bg-primary border-primary text-white' : 'border-surface text-muted-color hover:border-primary'"
                        (click)="selectShortcut(num)">
                        ⌘{{ num }}
                    </button>
                    }
                </div>
            </div>

            <!-- Browser -->
            <div id="home-edit-dialog-browser-section">
                <label class="block text-xs font-medium text-color mb-2">Default
                    Browser</label>
                <div id="home-edit-dialog-browser-options" class="flex flex-wrap gap-2">
                    @for (browser of availableBrowsers(); track browser; let i = $index) {
                    <button [id]="'home-edit-dialog-browser-' + i"
                        class="px-3 py-2 rounded-lg border text-sm cursor-pointer transition-all duration-150 flex items-center gap-2"
                        [class]="editBrowser() === browser ? 'bg-primary border-primary text-white' : 'border-surface text-muted-color hover:border-primary'"
                        (click)="selectBrowser($any(browser))">
                        <i [class]="'pi ' + browserInfo[browser].icon"></i>
                        {{ browserInfo[browser].name }}
                    </button>
                    }
                </div>
            </div>

            <!-- Phase 1: Color Coding -->
            <div id="home-edit-dialog-color-section">
                <label class="block text-xs font-medium text-color mb-2">Color</label>
                <div id="home-edit-dialog-color-options" class="flex flex-wrap gap-2">
                    <!-- Clear color option -->
                    <button id="home-edit-dialog-color-none"
                        class="w-8 h-8 rounded-full border-2 flex items-center justify-center cursor-pointer transition-all duration-150"
                        [class]="editColor() === null ? 'border-primary ring-2 ring-primary/30' : 'border-surface hover:border-primary'"
                        (click)="selectColor(null)" title="No color">
                        <i class="pi pi-times text-xs text-muted-color"></i>
                    </button>
                    @for (color of colorOptions; track color.name; let i = $index) {
                    <button [id]="'home-edit-dialog-color-' + i"
                        class="w-8 h-8 rounded-full border-2 cursor-pointer transition-all duration-150"
                        [style.background-color]="color.hex"
                        [class]="editColor() === color.hex ? 'border-primary ring-2 ring-primary/30' : 'border-transparent hover:ring-2 hover:ring-surface'"
                        (click)="selectColor(color.hex)" [title]="color.label">
                    </button>
                    }
                </div>
            </div>

            <!-- Tags -->
            <div id="home-edit-dialog-tags-section">
                <label class="block text-xs font-medium text-color mb-2">Tags</label>
                <div class="flex flex-wrap gap-2">
                    <input id="home-edit-dialog-tags-input" pInputText type="text"
                        placeholder="Type and press Enter to add tags" class="flex-1 min-w-[200px]"
                        (keydown.enter)="addTag($event)" />
                </div>
                @if (editTags().length > 0) {
                <div class="flex flex-wrap gap-2 mt-2">
                    @for (tag of editTags(); track tag; let i = $index) {
                    <span
                        class="inline-flex items-center gap-1.5 px-2.5 py-1 bg-primary/20 border border-primary/40 rounded-lg text-xs text-primary">
                        {{ tag }}
                        <button (click)="removeTag(i)" class="hover:text-muted-color transition-colors">
                            <i class="pi pi-times text-[10px]"></i>
                        </button>
                    </span>
                    }
                </div>
                }
            </div>

            <!-- Launch URL -->
            <div id="home-edit-dialog-url-section">
                <label for="home-edit-dialog-url-input" class="block text-xs font-medium text-color mb-2">Launch
                    URL</label>
                <input id="home-edit-dialog-url-input" pInputText type="url" [ngModel]="editLaunchUrl()"
                    (ngModelChange)="editLaunchUrl.set($event)" placeholder="https://example.com" class="w-full" />
                <p class="text-xs text-muted-color mt-1">Browser will open this URL when starting the profile</p>
            </div>

            <!-- Pin to Top -->
            <div id="home-edit-dialog-pin-section" class="flex items-center justify-between">
                <div>
                    <label class="block text-xs font-medium text-color">Pin to Top</label>
                    <p class="text-xs text-muted-color">Keep this profile at the top of the list</p>
                </div>
                <button (click)="editIsPinned.set(!editIsPinned())"
                    class="w-12 h-7 rounded-full transition-colors relative"
                    [class]="editIsPinned() ? 'bg-primary' : 'bg-surface-200 border border-surface'">
                    <span class="absolute top-1 w-5 h-5 rounded-full shadow transition-all"
                        [class]="editIsPinned() ? 'left-6' : 'left-1'"></span>
                </button>
            </div>

            <!-- Notes -->
            <div id="home-edit-dialog-notes-section">
                <label for="home-edit-dialog-notes-input"
                    class="block text-xs font-medium text-color mb-2">Notes</label>
                <textarea pInputTextarea id="home-edit-dialog-notes-input" [ngModel]="editNotes()"
                    (ngModelChange)="editNotes.set($event)" placeholder="What is this profile for?" rows="2"
                    class="w-full resize-none"></textarea>
            </div>
        </div>
        <ng-template #footer>
            <div id="home-edit-dialog-footer" class="flex justify-end gap-3 pt-2">
                <p-button id="home-edit-dialog-cancel-btn" label="Cancel" severity="secondary"
                    (click)="showEditDialog.set(false)" />
                <p-button id="home-edit-dialog-submit-btn" label="Save" (click)="saveProfileEdit()" />
            </div>
        </ng-template>
    </p-dialog>

    <!-- Duplicate Profile Dialog -->
    <p-dialog id="home-duplicate-dialog" header="Duplicate Profile" [(visible)]="showDuplicateDialog" [modal]="true"
        [style]="{ width: '400px' }" [draggable]="false" [resizable]="false">
        <div id="home-duplicate-dialog-content" class="py-2">
            <p class="text-sm text-muted-color mb-4">Create a copy of "{{ selectedProfile()?.name
                }}"</p>
            <label for="home-duplicate-dialog-name-input" class="block text-xs font-medium text-color mb-2">New
                Name</label>
            <input pInputText id="home-duplicate-dialog-name-input" type="text" [ngModel]="duplicateProfileName()"
                (ngModelChange)="duplicateProfileName.set($event)" class="w-full" />
        </div>
        <ng-template #footer>
            <div id="home-duplicate-dialog-footer" class="flex justify-end gap-3 pt-2">
                <p-button id="home-duplicate-dialog-cancel-btn" label="Cancel" severity="secondary"
                    (click)="showDuplicateDialog.set(false)" />
                <p-button id="home-duplicate-dialog-submit-btn" label="Duplicate" (click)="duplicateProfile()" />
            </div>
        </ng-template>
    </p-dialog>

    <!-- Phase 3: Activity Log Dialog -->
    <p-dialog id="home-activity-log-dialog" header="Activity Log" [(visible)]="showActivityLog" [modal]="true"
        [style]="{ width: '500px', maxHeight: '70vh' }" [draggable]="false" [resizable]="false">
        <div id="home-activity-log-content" class="py-2">
            @if (activityLog.entries().length === 0) {
            <div class="flex flex-col items-center justify-center py-8 text-center">
                <i class="pi pi-history text-3xl text-muted-color mb-3"></i>
                <p class="text-muted-color">No activity recorded yet</p>
                <p class="text-xs text-muted-color mt-1">Launch, create, or delete profiles to see activity here</p>
            </div>
            } @else {
            <div class="space-y-2 max-h-[400px] overflow-y-auto">
                @for (entry of activityLog.entries(); track entry.id; let i = $index) {
                <div [id]="'home-activity-entry-' + i"
                    class="flex items-start gap-3 p-3 rounded-lg border border-surface hover:bg-surface-50 dark:hover:bg-surface-800 transition-colors">
                    <!-- Icon -->
                    <div class="w-8 h-8 rounded-lg flex items-center justify-center shrink-0" [class]="{
                        'bg-green-500/20 text-green-500': entry.type === 'launch',
                        'bg-blue-500/20 text-blue-500': entry.type === 'create',
                        'bg-red-500/20 text-red-500': entry.type === 'delete',
                        'bg-purple-500/20 text-purple-500': entry.type === 'duplicate',
                        'bg-yellow-500/20 text-yellow-500': entry.type === 'edit'
                    }">
                        <i [class]="'pi ' + activityLog.getTypeIcon(entry.type)"></i>
                    </div>
                    <!-- Content -->
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center gap-2">
                            <span class="font-medium text-color truncate">{{ entry.profileName }}</span>
                            <span
                                class="text-xs px-1.5 py-0.5 rounded bg-surface-100 dark:bg-surface-700 text-muted-color">{{
                                activityLog.getTypeLabel(entry.type) }}</span>
                        </div>
                        <div class="flex items-center gap-2 mt-1 text-xs text-muted-color">
                            <span>{{ activityLog.formatTimestamp(entry.timestamp) }}</span>
                            @if (entry.browser) {
                            <span>• {{ entry.browser | titlecase }}</span>
                            }
                            @if (entry.details) {
                            <span>• {{ entry.details }}</span>
                            }
                        </div>
                    </div>
                </div>
                }
            </div>
            }
        </div>
        <ng-template #footer>
            <div id="home-activity-log-footer" class="flex justify-between items-center pt-2">
                <p-button id="home-activity-log-clear-btn" label="Clear Log" severity="danger" [outlined]="true"
                    icon="pi pi-trash" (click)="activityLog.clearLog()"
                    [disabled]="activityLog.entries().length === 0" />
                <p-button id="home-activity-log-close-btn" label="Close" severity="secondary"
                    (click)="showActivityLog.set(false)" />
            </div>
        </ng-template>
    </p-dialog>
</div>