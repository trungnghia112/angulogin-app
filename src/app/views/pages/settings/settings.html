<!-- Settings Page Layout: Sidebar + Content -->

<!-- Sidebar -->
<aside id="settings-sidebar"
    class="flex flex-col h-full w-60 border-r border-surface-100 dark:border-surface-800 bg-surface-0 dark:bg-surface-900 shrink-0">

    <!-- Header -->
    <div id="settings-sidebar-header"
        class="h-[var(--spacing-header)] flex items-center px-6 border-b border-surface-100 dark:border-surface-800 shrink-0">
        <h1 id="settings-sidebar-title" class="text-xl font-bold text-color">Settings</h1>
    </div>

    <!-- Navigation -->
    <nav id="settings-sidebar-nav" class="flex-1 p-3 flex flex-col gap-1 overflow-y-auto">
        @for (category of categories; track category.id; let i = $index) {
        <button [id]="'settings-nav-' + category.id" (click)="selectCategory(category.id)"
            class="w-full flex items-center gap-3 px-4 py-3 rounded-lg text-sm font-medium transition-colors text-left"
            [class]="activeCategory() === category.id 
                ? 'bg-primary/10 text-primary' 
                : 'text-muted-color hover:bg-surface-100 dark:hover:bg-surface-800 hover:text-color'">
            <i [class]="category.icon + ' text-lg'"></i>
            {{ category.label }}
        </button>
        }
    </nav>
</aside>

<!-- Content Area -->
<div id="settings-content" class="flex-1 flex flex-col bg-surface-50 dark:bg-surface-950 min-h-0 overflow-hidden">

    <!-- Content Header -->
    <div id="settings-content-header"
        class="h-[var(--spacing-header)] flex items-center px-8 border-b border-surface-100 dark:border-surface-800 bg-surface-0 dark:bg-surface-900 shrink-0">
        <h2 class="text-lg font-semibold text-color capitalize">{{ activeCategory() }}</h2>
    </div>

    <!-- Scrollable Content -->
    <div class="flex-1 p-8 overflow-y-auto">

        <!-- Appearance Section -->
        @if (activeCategory() === 'appearance') {
        <div class="max-w-3xl flex flex-col gap-8">

            <!-- Dark Mode Toggle -->
            <section id="settings-darkmode"
                class="bg-surface-0 dark:bg-surface-900 p-6 rounded-xl border border-surface-100 dark:border-surface-800">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-base font-semibold text-color mb-1">Dark Mode</h3>
                        <p class="text-sm text-muted-color">Switch between light and dark themes</p>
                    </div>
                    <p-button [icon]="settingsService.isDarkMode() ? 'pi pi-sun' : 'pi pi-moon'"
                        [label]="settingsService.isDarkMode() ? 'Light' : 'Dark'" [outlined]="true"
                        (click)="toggleDarkMode()" />
                </div>
            </section>

            <!-- Primary Color -->
            <section id="settings-primary-color"
                class="bg-surface-0 dark:bg-surface-900 p-6 rounded-xl border border-surface-100 dark:border-surface-800">
                <h3 class="text-sm font-semibold text-muted-color mb-4 uppercase tracking-wider">Primary Color</h3>
                <div class="flex flex-wrap gap-4">
                    @for (color of primaryColors; track color.name) {
                    <button [id]="'settings-color-' + color.name" (click)="setPrimaryColor(color.name)"
                        class="w-12 h-12 rounded-full border-2 transition-all duration-200 shadow-sm relative flex items-center justify-center shrink-0 cursor-pointer"
                        [class.border-surface-100]="settingsService.appearance().primaryColor !== color.name"
                        [class.dark:border-surface-800]="settingsService.appearance().primaryColor !== color.name"
                        [class.border-primary]="settingsService.appearance().primaryColor === color.name"
                        [class.ring-2]="settingsService.appearance().primaryColor === color.name"
                        [class.ring-offset-2]="settingsService.appearance().primaryColor === color.name"
                        [class.ring-primary]="settingsService.appearance().primaryColor === color.name"
                        [style.background-color]="color.hex" [pTooltip]="color.label" tooltipPosition="top">
                        @if (settingsService.appearance().primaryColor === color.name) {
                        <i class="pi pi-check text-white font-bold text-lg drop-shadow-md"></i>
                        }
                    </button>
                    }
                    <!-- Custom Color Picker -->
                    <label id="settings-color-custom" pTooltip="Custom Color" tooltipPosition="top"
                        class="w-12 h-12 rounded-full border-2 transition-all duration-200 shadow-sm relative flex items-center justify-center shrink-0 cursor-pointer overflow-hidden"
                        [class.border-surface-100]="settingsService.appearance().primaryColor !== 'custom'"
                        [class.dark:border-surface-800]="settingsService.appearance().primaryColor !== 'custom'"
                        [class.border-primary]="settingsService.appearance().primaryColor === 'custom'"
                        [class.ring-2]="settingsService.appearance().primaryColor === 'custom'"
                        [class.ring-offset-2]="settingsService.appearance().primaryColor === 'custom'"
                        [class.ring-primary]="settingsService.appearance().primaryColor === 'custom'"
                        [style.background]="settingsService.appearance().primaryColor === 'custom'
                            ? settingsService.appearance().customPrimaryHex
                            : 'conic-gradient(red, yellow, lime, aqua, blue, magenta, red)'">
                        @if (settingsService.appearance().primaryColor === 'custom') {
                        <i class="pi pi-check text-white font-bold text-lg drop-shadow-md"></i>
                        } @else {
                        <i class="pi pi-palette text-white font-bold text-sm drop-shadow-md"></i>
                        }
                        <input type="color" class="absolute inset-0 opacity-0 cursor-pointer w-full h-full"
                            [value]="settingsService.appearance().customPrimaryHex || '#6366f1'"
                            (input)="setCustomColor($event)" />
                    </label>
                </div>
            </section>

            <!-- Surface Palette -->
            <section id="settings-surface"
                class="bg-surface-0 dark:bg-surface-900 p-6 rounded-xl border border-surface-100 dark:border-surface-800">
                <h3 class="text-sm font-semibold text-muted-color mb-4 uppercase tracking-wider">Background Theme</h3>
                <div class="flex flex-wrap gap-4">
                    @for (surface of surfacePalettes; track surface.name) {
                    <button [id]="'settings-surface-' + surface.name" (click)="setSurface(surface.name)"
                        class="flex-1 min-w-[100px] h-12 rounded-lg border-2 transition-all duration-200 shadow-sm relative flex items-center justify-center shrink-0 cursor-pointer bg-surface-100 dark:bg-surface-800"
                        [class.border-surface-100]="settingsService.appearance().surface !== surface.name"
                        [class.dark:border-surface-800]="settingsService.appearance().surface !== surface.name"
                        [class.border-primary]="settingsService.appearance().surface === surface.name">
                        <div class="flex items-center gap-2">
                            <div class="w-5 h-5 rounded-full border border-surface-100 dark:border-surface-800"
                                [style.background-color]="surface.hex"></div>
                            <span class="text-sm font-medium text-color">{{ surface.label }}</span>
                        </div>
                        @if (settingsService.appearance().surface === surface.name) {
                        <div
                            class="absolute -top-1 -right-1 w-5 h-5 bg-primary text-white rounded-full flex items-center justify-center shadow-sm">
                            <i class="pi pi-check text-[10px] font-bold"></i>
                        </div>
                        }
                    </button>
                    }
                </div>
            </section>

            <!-- UI Scale -->
            <section id="settings-scale"
                class="bg-surface-0 dark:bg-surface-900 p-6 rounded-xl border border-surface-100 dark:border-surface-800">
                <h3 class="text-sm font-semibold text-muted-color mb-4 uppercase tracking-wider">Interface Scale</h3>
                <div class="flex items-center gap-4">
                    @for (scale of uiScales; track scale.value) {
                    <button [id]="'settings-scale-' + scale.value" (click)="setScale(scale.value)"
                        class="px-6 py-3 rounded-lg text-sm font-medium transition-all cursor-pointer"
                        [class]="settingsService.appearance().scale === scale.value 
                            ? 'bg-primary text-primary-contrast shadow-sm' 
                            : 'bg-surface-100 dark:bg-surface-800 text-muted-color hover:text-color hover:bg-surface-200 dark:hover:bg-surface-700'">
                        {{ scale.label }}
                    </button>
                    }
                </div>
            </section>

        </div>
        }

        <!-- General Section -->
        @if (activeCategory() === 'general') {
        <div class="max-w-3xl flex flex-col gap-8">

            <!-- Startup Behavior -->
            <section
                class="bg-surface-0 dark:bg-surface-900 p-6 rounded-xl border border-surface-100 dark:border-surface-800">
                <h3 class="text-base font-semibold text-color mb-6">Startup & Launch</h3>

                <div class="flex flex-col gap-6">
                    <!-- Default Browser -->
                    <div class="flex flex-col gap-3">
                        <label class="text-sm font-medium text-muted-color">Default Browser Engine</label>
                        <p-selectButton [options]="browserOptions" [ngModel]="settingsService.general().defaultBrowser"
                            optionLabel="label" optionValue="value" (onChange)="updateGeneral('defaultBrowser', $event)"
                            styleClass="w-full">
                            <ng-template let-item pTemplate>
                                <div class="flex items-center justify-center gap-2 w-full">
                                    <i [class]="item.icon"></i>
                                    <span>{{item.label}}</span>
                                </div>
                            </ng-template>
                        </p-selectButton>
                        <p class="text-xs text-muted-color">Used when creating new profiles or launching Quick Actions.
                        </p>
                    </div>

                    <!-- On Launch -->
                    <div class="flex flex-col gap-3">
                        <label class="text-sm font-medium text-muted-color">After Launching Profile</label>
                        <p-selectButton [options]="launchOptions" [ngModel]="settingsService.general().onLaunch"
                            optionLabel="label" optionValue="value" (onChange)="updateGeneral('onLaunch', $event)"
                            styleClass="w-full">
                            <ng-template let-item pTemplate>
                                <div class="flex items-center justify-center gap-2 w-full">
                                    <i [class]="item.icon"></i>
                                    <span>{{item.label}}</span>
                                </div>
                            </ng-template>
                        </p-selectButton>
                    </div>
                </div>
            </section>

            <!-- Application Config -->
            <section
                class="bg-surface-0 dark:bg-surface-900 p-6 rounded-xl border border-surface-100 dark:border-surface-800">
                <h3 class="text-base font-semibold text-color mb-6">Application Preferences</h3>

                <div class="flex flex-col gap-4">
                    <!-- Launch at Startup -->
                    <div
                        class="flex items-center justify-between p-2 hover:bg-surface-50 dark:hover:bg-surface-800/50 rounded-lg transition-colors">
                        <div>
                            <p class="text-sm font-medium text-color">Launch at Startup</p>
                            <p class="text-xs text-muted-color">Automatically start app when you log in</p>
                        </div>
                        <p-toggleSwitch [ngModel]="settingsService.general().launchAtStartup"
                            (onChange)="updateGeneral('launchAtStartup', $event)" />
                    </div>

                    <div class="h-px bg-surface-100 dark:bg-surface-800"></div>

                    <!-- Start Minimized -->
                    <div class="flex items-center justify-between p-2 hover:bg-surface-50 dark:hover:bg-surface-800/50 rounded-lg transition-colors"
                        [class.opacity-50]="!settingsService.general().launchAtStartup"
                        [class.pointer-events-none]="!settingsService.general().launchAtStartup">
                        <div>
                            <p class="text-sm font-medium text-color">Start Minimized</p>
                            <p class="text-xs text-muted-color">Do not show main window on startup</p>
                        </div>
                        <p-toggleSwitch [ngModel]="settingsService.general().startMinimized"
                            [disabled]="!settingsService.general().launchAtStartup"
                            (onChange)="updateGeneral('startMinimized', $event)" />
                    </div>

                    <div class="h-px bg-surface-100 dark:bg-surface-800"></div>

                    <!-- Confirm Delete -->
                    <div
                        class="flex items-center justify-between p-2 hover:bg-surface-50 dark:hover:bg-surface-800/50 rounded-lg transition-colors">
                        <div>
                            <p class="text-sm font-medium text-color">Confirm Deletion</p>
                            <p class="text-xs text-muted-color">Show warning before deleting a profile</p>
                        </div>
                        <p-toggleSwitch [ngModel]="settingsService.general().confirmDelete"
                            (onChange)="updateGeneral('confirmDelete', $event)" />
                    </div>
                </div>
            </section>

            <!-- Default Protection Level -->
            <section id="settings-default-protection"
                class="bg-surface-0 dark:bg-surface-900 p-6 rounded-xl border border-surface-100 dark:border-surface-800">
                <h3 class="text-base font-semibold text-color mb-2">Default Protection Level</h3>
                <p class="text-sm text-muted-color mb-6">Applied automatically when creating new profiles.</p>

                <div class="flex flex-col gap-3">
                    @for (level of protectionLevelOptions; track level.value) {
                    <button [id]="'settings-protection-' + level.value"
                        (click)="updateGeneral('defaultProtectionLevel', level.value)"
                        class="flex items-start gap-4 p-4 rounded-lg border-2 transition-all cursor-pointer text-left"
                        [class]="settingsService.general().defaultProtectionLevel === level.value
                            ? 'border-primary bg-primary/5 dark:bg-primary/10'
                            : 'border-surface-200 dark:border-surface-700 hover:border-surface-300 dark:hover:border-surface-600 bg-surface-50 dark:bg-surface-800/50'">
                        <div class="w-10 h-10 rounded-lg flex items-center justify-center shrink-0 mt-0.5"
                            [class]="level.bgClass">
                            <i [class]="level.icon + ' text-lg ' + level.iconClass"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2">
                                <span class="text-sm font-semibold text-color">{{ level.label }}</span>
                                @if (settingsService.general().defaultProtectionLevel === level.value) {
                                <i class="pi pi-check-circle text-primary text-sm"></i>
                                }
                            </div>
                            <p class="text-xs text-muted-color mt-1 leading-relaxed">{{ level.description }}</p>
                        </div>
                    </button>
                    }
                </div>
            </section>

        </div>
        }

        <!-- Browser Paths Section -->
        @if (activeCategory() === 'browser') {
        <div class="max-w-3xl flex flex-col gap-8">

            <section id="settings-browser-path"
                class="bg-surface-0 dark:bg-surface-900 p-6 rounded-xl border border-surface-100 dark:border-surface-800">
                <div class="mb-4">
                    <h3 class="text-base font-semibold text-color mb-1">Profiles Directory</h3>
                    <p class="text-sm text-muted-color">Select the folder where your Chrome User Data is stored.</p>
                </div>

                <div class="flex flex-col gap-2">
                    <p-inputGroup>
                        <input pInputText [value]="settingsService.browser().profilesPath" readonly
                            placeholder="No folder selected" class="w-full" />
                        <button type="button" pButton label="Browse" icon="pi pi-folder-open"
                            (click)="browseProfilesPath()"></button>
                    </p-inputGroup>

                    <div class="flex justify-end mt-2">
                        <p-button label="Reset to Default" icon="pi pi-refresh" [text]="true" severity="secondary"
                            size="small" (click)="resetProfilesPath()" />
                    </div>
                </div>
            </section>

            <!-- Feature 10.4: Additional Directories -->
            <section id="settings-browser-additional-paths"
                class="bg-surface-0 dark:bg-surface-900 p-6 rounded-xl border border-surface-100 dark:border-surface-800">
                <div class="mb-4">
                    <h3 class="text-base font-semibold text-color mb-1">Additional Directories</h3>
                    <p class="text-sm text-muted-color">Add extra folders to scan for profiles (multi-drive support).
                    </p>
                </div>

                <div class="flex flex-col gap-2">
                    @for (path of settingsService.additionalPaths(); track path) {
                    <div class="flex items-center gap-2">
                        <input pInputText [value]="path" readonly class="w-full text-sm" />
                        <p-button icon="pi pi-trash" severity="danger" [text]="true" size="small"
                            (click)="removeAdditionalPath(path)" pTooltip="Remove" />
                    </div>
                    }

                    <div class="flex justify-end mt-2">
                        <p-button label="Add Directory" icon="pi pi-plus" [text]="true" severity="secondary"
                            size="small" (click)="browseAdditionalPath()" />
                    </div>
                </div>
            </section>

        </div>
        }

        <!-- Data Section -->
        @if (activeCategory() === 'data') {
        <div class="max-w-3xl flex flex-col gap-8">

            <!-- Backup & Restore -->
            <section
                class="bg-surface-0 dark:bg-surface-900 p-6 rounded-xl border border-surface-100 dark:border-surface-800">
                <h3 class="text-base font-semibold text-color mb-6">Backup & Restore</h3>

                <div class="flex flex-col gap-6">
                    <!-- Export -->
                    <div class="flex items-center justify-between p-4 bg-surface-50 dark:bg-surface-800/50 rounded-lg">
                        <div>
                            <p class="text-sm font-medium text-color">Export Configuration</p>
                            <p class="text-xs text-muted-color">Save your settings to a JSON file for backup</p>
                        </div>
                        <p-button label="Export" icon="pi pi-download" [outlined]="true" (click)="exportConfig()" />
                    </div>

                    <!-- Import -->
                    <div class="flex items-center justify-between p-4 bg-surface-50 dark:bg-surface-800/50 rounded-lg">
                        <div>
                            <p class="text-sm font-medium text-color">Import Configuration</p>
                            <p class="text-xs text-muted-color">Restore settings from a previously exported file</p>
                        </div>
                        <p-button label="Import" icon="pi pi-upload" [outlined]="true" (click)="importConfig()" />
                    </div>

                    <!-- Restore Profile from Backup -->
                    <div class="flex items-center justify-between p-4 bg-surface-50 dark:bg-surface-800/50 rounded-lg">
                        <div>
                            <p class="text-sm font-medium text-color">Restore Profile from Backup</p>
                            <p class="text-xs text-muted-color">Extract and restore a profile from a .zip backup file
                            </p>
                        </div>
                        <p-button label="Restore" icon="pi pi-history" [outlined]="true"
                            (click)="openRestoreDialog()" />
                    </div>
                </div>
            </section>

            <!-- Auto Backup (Feature 5.4) -->
            <section
                class="bg-surface-0 dark:bg-surface-900 p-6 rounded-xl border border-surface-100 dark:border-surface-800">
                <h3 class="text-base font-semibold text-color mb-6">
                    <i class="pi pi-clock text-blue-500 mr-2"></i>
                    Automatic Backup
                </h3>

                <div class="flex flex-col gap-6">
                    <!-- Enable Toggle -->
                    <div
                        class="flex items-center justify-between p-2 hover:bg-surface-50 dark:hover:bg-surface-800/50 rounded-lg transition-colors">
                        <div>
                            <p class="text-sm font-medium text-color">Enable Auto Backup</p>
                            <p class="text-xs text-muted-color">Automatically backup all profiles on a schedule</p>
                        </div>
                        <p-toggleSwitch [ngModel]="settingsService.autoBackup().enabled"
                            (onChange)="updateAutoBackup('enabled', $event)" />
                    </div>

                    <div class="h-px bg-surface-100 dark:bg-surface-800"></div>

                    <!-- Interval Selection -->
                    <div class="flex flex-col gap-3" [class.opacity-50]="!settingsService.autoBackup().enabled">
                        <label class="text-sm font-medium text-muted-color">Backup Frequency</label>
                        <p-selectButton [options]="backupIntervalOptions"
                            [ngModel]="settingsService.autoBackup().intervalDays" optionLabel="label"
                            optionValue="value" (onChange)="updateAutoBackup('intervalDays', $event)"
                            [disabled]="!settingsService.autoBackup().enabled" />
                    </div>

                    <div class="h-px bg-surface-100 dark:bg-surface-800"></div>

                    <!-- Destination Folder -->
                    <div class="flex flex-col gap-3" [class.opacity-50]="!settingsService.autoBackup().enabled">
                        <label class="text-sm font-medium text-muted-color">Backup Destination</label>
                        <p-inputGroup>
                            <input pInputText [value]="settingsService.autoBackup().destinationFolder" readonly
                                placeholder="Select backup folder" class="w-full" />
                            <button type="button" pButton label="Browse" icon="pi pi-folder-open"
                                (click)="browseBackupFolder()"
                                [disabled]="!settingsService.autoBackup().enabled"></button>
                        </p-inputGroup>
                        @if (settingsService.autoBackup().lastBackupDate) {
                        <p class="text-xs text-muted-color">
                            Last backup: {{ formatBackupDate(settingsService.autoBackup().lastBackupDate) }}
                        </p>
                        }
                    </div>

                    <div class="h-px bg-surface-100 dark:bg-surface-800"></div>

                    <!-- Backup Now Button -->
                    <div class="flex items-center justify-between p-4 bg-surface-50 dark:bg-surface-800/50 rounded-lg">
                        <div>
                            <p class="text-sm font-medium text-color">Backup Now</p>
                            <p class="text-xs text-muted-color">Manually trigger a backup of all profiles</p>
                        </div>
                        <p-button label="Backup All" icon="pi pi-save" [outlined]="true" [loading]="backingUp()"
                            [disabled]="!settingsService.autoBackup().destinationFolder" (click)="runManualBackup()" />
                    </div>
                </div>
            </section>

            <!-- Danger Zone -->
            <section
                class="bg-surface-0 dark:bg-surface-900 p-6 rounded-xl border border-red-200 dark:border-red-900/50">
                <h3 class="text-base font-semibold text-red-600 dark:text-red-400 mb-6">Danger Zone</h3>

                <div
                    class="flex items-center justify-between p-4 bg-red-50 dark:bg-red-950/30 rounded-lg border border-red-100 dark:border-red-900/30">
                    <div>
                        <p class="text-sm font-medium text-color">Clear All Data</p>
                        <p class="text-xs text-muted-color">Reset all settings to default. This cannot be undone.</p>
                    </div>
                    <p-button label="Clear Data" icon="pi pi-trash" severity="danger" (click)="clearData()" />
                </div>
            </section>

        </div>
        }

        <!-- Local API Section -->
        @if (activeCategory() === 'api') {
        <div class="max-w-3xl flex flex-col gap-8">

            <!-- API Toggle -->
            <section id="settings-api-toggle"
                class="bg-surface-0 dark:bg-surface-900 p-6 rounded-xl border border-surface-100 dark:border-surface-800">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-base font-semibold text-color mb-1">Enable Local REST API</h3>
                        <p class="text-sm text-muted-color">Allow external tools to control profiles via HTTP on
                            localhost.</p>
                    </div>
                    <p-toggleSwitch [ngModel]="apiService.isEnabled()" (onChange)="toggleApi()" />
                </div>
            </section>

            <!-- Connection Info -->
            <section id="settings-api-connection"
                class="bg-surface-0 dark:bg-surface-900 p-6 rounded-xl border border-surface-100 dark:border-surface-800"
                [class.opacity-50]="!apiService.isEnabled()" [class.pointer-events-none]="!apiService.isEnabled()">
                <h3 class="text-sm font-semibold text-muted-color mb-5 uppercase tracking-wider">Connection</h3>

                <div class="flex flex-col gap-5">
                    <!-- Port -->
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-color">Port</p>
                            <p class="text-xs text-muted-color">Changes take effect on next app restart.</p>
                        </div>
                        <div class="flex items-center gap-2">
                            @if (apiPortEditing()) {
                            <input id="settings-api-port-input" pInputText type="number" [ngModel]="apiPortValue()"
                                (ngModelChange)="apiPortValue.set($event)" class="w-28 text-right" />
                            <p-button icon="pi pi-check" [rounded]="true" [text]="true" severity="success"
                                (click)="saveApiPort()" pTooltip="Save" />
                            <p-button icon="pi pi-times" [rounded]="true" [text]="true" severity="secondary"
                                (click)="apiPortEditing.set(false)" pTooltip="Cancel" />
                            } @else {
                            <span class="text-sm font-mono text-color bg-surface-100 dark:bg-surface-800 px-3 py-1.5 rounded-lg">{{
                                apiService.port() }}</span>
                            <p-button icon="pi pi-pencil" [rounded]="true" [text]="true" severity="secondary"
                                size="small" (click)="apiPortEditing.set(true)" pTooltip="Edit" />
                            }
                        </div>
                    </div>

                    <div class="h-px bg-surface-100 dark:bg-surface-800"></div>

                    <!-- Connection URL -->
                    <div>
                        <p class="text-sm font-medium text-color mb-2">Base URL</p>
                        <div
                            class="flex items-center gap-3 px-4 py-3 bg-surface-50 dark:bg-surface-800/50 rounded-lg font-mono text-sm text-color">
                            <i class="pi pi-link text-muted-color"></i>
                            <span>{{ apiService.connectionUrl() }}</span>
                        </div>
                    </div>
                </div>
            </section>

            <!-- API Key -->
            <section id="settings-api-key"
                class="bg-surface-0 dark:bg-surface-900 p-6 rounded-xl border border-surface-100 dark:border-surface-800"
                [class.opacity-50]="!apiService.isEnabled()" [class.pointer-events-none]="!apiService.isEnabled()">
                <div class="flex items-center justify-between mb-5">
                    <div>
                        <h3 class="text-sm font-semibold text-muted-color uppercase tracking-wider">API Key</h3>
                    </div>
                    <div class="flex items-center gap-2">
                        <p-button [icon]="apiKeyVisible() ? 'pi pi-eye-slash' : 'pi pi-eye'" [rounded]="true"
                            [text]="true" severity="secondary" size="small"
                            (click)="apiKeyVisible.set(!apiKeyVisible())"
                            [pTooltip]="apiKeyVisible() ? 'Hide' : 'Show'" />
                    </div>
                </div>

                <!-- Key Display -->
                <div
                    class="flex items-center gap-3 px-4 py-3 bg-surface-50 dark:bg-surface-800/50 rounded-lg mb-4">
                    <i class="pi pi-key text-muted-color"></i>
                    <span class="flex-1 font-mono text-sm text-color select-all">
                        {{ apiKeyVisible() ? apiService.apiKey() : getMaskedKey() }}
                    </span>
                    <p-button [icon]="apiKeyCopied() ? 'pi pi-check' : 'pi pi-copy'" [rounded]="true" [text]="true"
                        [severity]="apiKeyCopied() ? 'success' : 'secondary'" size="small" (click)="copyApiKey()"
                        [pTooltip]="apiKeyCopied() ? 'Copied!' : 'Copy'" />
                </div>

                <!-- Actions -->
                <div class="flex items-center justify-between">
                    <p class="text-xs text-muted-color">Use as <span class="font-mono">Authorization: Bearer
                            &lt;key&gt;</span></p>
                    <p-button label="Regenerate" icon="pi pi-refresh" [outlined]="true" size="small"
                        [loading]="apiRegenerating()" (click)="regenerateApiKey()" />
                </div>
            </section>

            <!-- Quick Reference -->
            <section id="settings-api-reference"
                class="bg-surface-0 dark:bg-surface-900 p-6 rounded-xl border border-surface-100 dark:border-surface-800"
                [class.opacity-50]="!apiService.isEnabled()" [class.pointer-events-none]="!apiService.isEnabled()">
                <h3 class="text-sm font-semibold text-muted-color mb-5 uppercase tracking-wider">Quick Reference</h3>

                <div class="flex flex-col gap-3">
                    <div class="flex items-center gap-3 text-sm">
                        <span class="px-2 py-0.5 bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400 rounded font-mono text-xs font-semibold">GET</span>
                        <span class="font-mono text-muted-color">/api/v1/status</span>
                        <span class="text-xs text-muted-color ml-auto">Health check (public)</span>
                    </div>
                    <div class="flex items-center gap-3 text-sm">
                        <span class="px-2 py-0.5 bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400 rounded font-mono text-xs font-semibold">GET</span>
                        <span class="font-mono text-muted-color">/api/v1/browser/open</span>
                        <span class="text-xs text-muted-color ml-auto">Open profile + CDP</span>
                    </div>
                    <div class="flex items-center gap-3 text-sm">
                        <span class="px-2 py-0.5 bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400 rounded font-mono text-xs font-semibold">GET</span>
                        <span class="font-mono text-muted-color">/api/v1/profile/list</span>
                        <span class="text-xs text-muted-color ml-auto">List all profiles</span>
                    </div>
                    <div class="flex items-center gap-3 text-sm">
                        <span class="px-2 py-0.5 bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-400 rounded font-mono text-xs font-semibold">POST</span>
                        <span class="font-mono text-muted-color">/api/v1/profile/create</span>
                        <span class="text-xs text-muted-color ml-auto">Create new profile</span>
                    </div>
                </div>

                <div class="mt-5 p-4 bg-surface-50 dark:bg-surface-800/50 rounded-lg">
                    <p class="text-xs text-muted-color mb-2">Example cURL:</p>
                    <code class="text-xs font-mono text-color leading-relaxed block">curl -H "Authorization: Bearer &lt;key&gt;" {{ apiService.connectionUrl() }}/api/v1/profile/list</code>
                </div>
            </section>

        </div>
        }

        <!-- Proxy Section -->
        @if (activeCategory() === 'proxy') {
        <div class="max-w-3xl flex flex-col gap-8">

            <!-- Proxy List -->
            <section
                class="bg-surface-0 dark:bg-surface-900 p-6 rounded-xl border border-surface-100 dark:border-surface-800">
                <div class="flex items-center justify-between mb-6">
                    <div>
                        <h3 class="text-base font-semibold text-color">Proxy Servers</h3>
                        <p class="text-sm text-muted-color">{{ proxyService.proxyCount() }} proxies configured</p>
                    </div>
                    <div class="flex gap-2">
                        <p-button label="Add" icon="pi pi-plus" [outlined]="true" size="small"
                            (click)="openAddProxyDialog()" />
                        <p-button label="Import" icon="pi pi-upload" [outlined]="true" size="small"
                            (click)="openImportProxyDialog()" />
                        <p-button label="Check All" icon="pi pi-sync" [outlined]="true" size="small"
                            [loading]="checkingAll()" (click)="checkAllProxiesHealth()"
                            [disabled]="proxyService.proxyCount() === 0" />
                        <p-button label="Export" icon="pi pi-download" [outlined]="true" size="small"
                            (click)="proxyService.exportProxies()" [disabled]="proxyService.proxyCount() === 0" />
                    </div>
                </div>

                @if (proxyService.proxies().length === 0) {
                <div class="flex flex-col items-center justify-center py-8 text-center">
                    <i class="pi pi-globe text-3xl text-muted-color mb-3"></i>
                    <p class="text-muted-color">No proxies configured</p>
                    <p class="text-xs text-muted-color mt-1">Proxies are assigned to profiles in the profile edit dialog
                    </p>
                </div>
                } @else {
                <div class="flex flex-col gap-3">
                    @for (proxy of proxyService.proxies(); track proxy.id; let i = $index) {
                    <div class="flex items-center justify-between p-4 bg-surface-50 dark:bg-surface-800/50 rounded-lg">
                        <div class="flex items-center gap-4">
                            <!-- Health Status Indicator -->
                            <i [class]="getHealthStatusIcon(proxy)" pTooltip="{{ getHealthStatusText(proxy) }}"></i>

                            <!-- Proxy Info -->
                            <div>
                                <p class="text-sm font-medium text-color">{{ proxy.name }}</p>
                                <p class="text-xs text-muted-color">{{ proxy.type }}://{{ proxy.host }}:{{ proxy.port }}
                                </p>
                            </div>

                            <!-- Group Badge -->
                            @if (proxy.group) {
                            <span class="px-2 py-0.5 bg-primary/20 text-primary text-xs rounded">{{ proxy.group
                                }}</span>
                            }
                        </div>

                        <div class="flex items-center gap-2">
                            <!-- Latency -->
                            @if (proxy.isAlive && proxy.latencyMs) {
                            <span class="text-xs text-muted-color">{{ proxy.latencyMs }}ms</span>
                            }

                            <!-- Check Button -->
                            <p-button icon="pi pi-sync" [rounded]="true" [text]="true" severity="secondary" size="small"
                                pTooltip="Check Health" [loading]="checkingProxyId() === proxy.id"
                                (click)="checkProxyHealth(proxy)" />

                            <!-- Delete Button -->
                            <p-button icon="pi pi-trash" [rounded]="true" [text]="true" severity="danger" size="small"
                                pTooltip="Remove Proxy" (click)="proxyService.remove(proxy.id)" />
                        </div>
                    </div>
                    }
                </div>
                }
            </section>

            <!-- Health Check Info -->
            <section
                class="bg-surface-0 dark:bg-surface-900 p-6 rounded-xl border border-surface-100 dark:border-surface-800">
                <h3 class="text-sm font-semibold text-muted-color mb-4 uppercase tracking-wider">Health Status Legend
                </h3>
                <div class="flex gap-6">
                    <div class="flex items-center gap-2">
                        <i class="pi pi-circle-fill text-green-500"></i>
                        <span class="text-sm text-muted-color">Online</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <i class="pi pi-circle-fill text-red-500"></i>
                        <span class="text-sm text-muted-color">Offline</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <i class="pi pi-circle text-gray-400"></i>
                        <span class="text-sm text-muted-color">Not Checked</span>
                    </div>
                </div>
            </section>

        </div>
        }

    </div>
</div>

<!-- Restore Profile Dialog -->
<p-dialog id="settings-restore-dialog" header="Restore Profile from Backup" [(visible)]="showRestoreDialog"
    [modal]="true" [style]="{ width: '480px' }" [closable]="true">
    <div class="flex flex-col gap-6 py-2">

        <!-- Select File -->
        <div class="flex flex-col gap-2">
            <label class="text-sm font-medium text-color">Backup File</label>
            <div class="flex gap-2">
                <input pInputText [value]="selectedBackupPath()" readonly placeholder="Select a .zip backup file"
                    class="flex-1" />
                <p-button icon="pi pi-folder-open" (click)="selectBackupFile()" pTooltip="Browse" />
            </div>
        </div>

        <!-- Conflict Action -->
        <div class="flex flex-col gap-2">
            <label class="text-sm font-medium text-color">If profile already exists</label>
            <p-selectButton [options]="conflictOptions" [(ngModel)]="conflictAction" optionLabel="label"
                optionValue="value" />
            <p class="text-xs text-muted-color">
                @switch (conflictAction()) {
                @case ('rename') { Profile will be restored with a new name (e.g., "Profile (Restored 1)") }
                @case ('overwrite') { Existing profile will be replaced with the backup }
                @case ('skip') { Restore will be cancelled if profile exists }
                }
            </p>
        </div>

    </div>

    <ng-template #footer>
        <div class="flex justify-end gap-2">
            <p-button label="Cancel" [text]="true" severity="secondary" (click)="showRestoreDialog.set(false)" />
            <p-button label="Restore" icon="pi pi-check" [loading]="restoring()"
                [disabled]="!selectedBackupPath() || restoring()" (click)="restoreBackup()" />
        </div>
    </ng-template>
</p-dialog>

<!-- Import Proxy Dialog -->
<p-dialog id="settings-import-proxy-dialog" header="Import Proxies" [(visible)]="showImportProxyDialog" [modal]="true"
    [style]="{ width: '560px' }" [closable]="true">
    <div class="flex flex-col gap-6 py-2">

        <!-- Format Selector -->
        <div class="flex flex-col gap-2">
            <label class="text-sm font-medium text-color">Format</label>
            <p-selectButton [options]="proxyFormatOptions" [ngModel]="importProxyFormat()" optionLabel="label"
                optionValue="value" (onChange)="importProxyFormat.set($event.value)" />
        </div>

        <!-- Proxy Text Input -->
        <div class="flex flex-col gap-2">
            <label class="text-sm font-medium text-color">Proxy List</label>
            <textarea pTextarea [ngModel]="importProxyText()" (ngModelChange)="importProxyText.set($event)" [rows]="10"
                [autoResize]="false" class="w-full font-mono text-sm"
                placeholder="31.59.20.176:6754:username:password&#10;23.95.150.145:6114:username:password&#10;..."></textarea>
            <p class="text-xs text-muted-color">One proxy per line.</p>
        </div>

    </div>

    <ng-template #footer>
        <div class="flex justify-end gap-2">
            <p-button label="Cancel" [text]="true" severity="secondary" (click)="showImportProxyDialog.set(false)" />
            <p-button label="Import" icon="pi pi-upload" [loading]="importingProxy()"
                [disabled]="!importProxyText().trim()" (click)="importProxies()" />
        </div>
    </ng-template>
</p-dialog>

<!-- Add Single Proxy Dialog -->
<p-dialog id="settings-add-proxy-dialog" header="Add Proxy" [(visible)]="showAddProxyDialog" [modal]="true"
    [style]="{ width: '480px' }" [closable]="true">
    <div class="flex flex-col gap-5 py-2">

        <!-- Type -->
        <div class="flex flex-col gap-2">
            <label class="text-sm font-medium text-color">Type</label>
            <p-selectButton [options]="proxyTypeOptions" [ngModel]="newProxyType()" optionLabel="label"
                optionValue="value" (onChange)="newProxyType.set($event.value)" />
        </div>

        <!-- Host + Port -->
        <div class="flex gap-4">
            <div class="flex flex-col gap-2 flex-1">
                <label class="text-sm font-medium text-color">Host</label>
                <input pInputText [ngModel]="newProxyHost()" (ngModelChange)="newProxyHost.set($event)"
                    placeholder="31.59.20.176" />
            </div>
            <div class="flex flex-col gap-2 w-28">
                <label class="text-sm font-medium text-color">Port</label>
                <input pInputText type="number" [ngModel]="newProxyPort()" (ngModelChange)="newProxyPort.set($event)"
                    placeholder="8080" />
            </div>
        </div>

        <!-- Username + Password (not supported for SOCKS4) -->
        <div class="flex gap-4" [class.opacity-40]="newProxyType() === 'socks4'"
            [class.pointer-events-none]="newProxyType() === 'socks4'">
            <div class="flex flex-col gap-2 flex-1">
                <label class="text-sm font-medium text-color">Username <span
                        class="text-muted-color">(optional)</span></label>
                <input pInputText [ngModel]="newProxyUsername()" (ngModelChange)="newProxyUsername.set($event)"
                    placeholder="username" [disabled]="newProxyType() === 'socks4'" />
            </div>
            <div class="flex flex-col gap-2 flex-1">
                <label class="text-sm font-medium text-color">Password <span
                        class="text-muted-color">(optional)</span></label>
                <input pInputText [ngModel]="newProxyPassword()" (ngModelChange)="newProxyPassword.set($event)"
                    placeholder="password" type="password" [disabled]="newProxyType() === 'socks4'" />
            </div>
        </div>
        @if (newProxyType() === 'socks4') {
        <p class="text-xs text-yellow-600 dark:text-yellow-400 flex items-center gap-1">
            <i class="pi pi-info-circle"></i>
            SOCKS4 does not support authentication
        </p>
        }

        <!-- Group -->
        <div class="flex flex-col gap-2">
            <label class="text-sm font-medium text-color">Group <span class="text-muted-color">(optional)</span></label>
            <input pInputText [ngModel]="newProxyGroup()" (ngModelChange)="newProxyGroup.set($event)"
                placeholder="e.g. US Proxies" />
        </div>

    </div>

    <ng-template #footer>
        <div class="flex justify-end gap-2">
            <p-button label="Cancel" [text]="true" severity="secondary" (click)="showAddProxyDialog.set(false)" />
            <p-button label="Add" icon="pi pi-plus" [disabled]="!newProxyHost().trim() || !newProxyPort()"
                (click)="addSingleProxy()" />
        </div>
    </ng-template>
</p-dialog>